!function(t,e,n,r){function a(r,a){function o(t,e){return t.isGet?d.get(t.str[0]):(d.set(t),void e())}var d=function(){var e="kladr-data",n=r.data(e);return n||(n=t.extend({},u,s),r.data(e,n)),{set:function(t){if(t.obj)for(var a in t.obj)l(t.obj,a)&&l(u,a)&&(n[a]=t.obj[a]);else t.str&&!t.isGet&&l(u,t.str[0])&&(n[t.str[0]]=t.str[1]);r.data(e,n)},get:function(t){return l(u,t)||l(s,t)?n[t]:void 0},_set:function(t,a){n[t]=a,r.data(e,n)},_get:function(t){return l(n,t)?n[t]:void 0}}}();return o(a,function(){function a(a){var o=t(n.getElementById("kladr_autocomplete"));o.length||(o=t('<div class="form-control-group__suggest suggest-control"></div>').insertAfter(r));var l=I("guid");l?(A=o.find(".autocomplete"+l),V=o.find(".spinner"+l),t(e).off(x),r.off(x),A.off(x)):(l=i(),B("guid",l),r.attr("autocomplete","off"),A=t('<ul class="suggest-control-lst autocomplete'+l+' autocomplete" style="display: none;"></ul>').appendTo(o),V=t('<div class="spinner'+l+' spinner" style="display: none;"></div>').appendTo(o),y(),u(),k()),a()}function o(e,n){var r,a,o,i;A.empty();for(var l=0;l<e.length;l++)r=e[l],a=I("valueFormat")(r,n),o=I("labelFormat")(r,n),i=t('<a data-val="'+a+'">'+o+"</a>"),i.data("kladr-object",r),t("<li></li>").append(i).appendTo(A)}function u(){var t=r.offset(),e=r.outerWidth(),n=r.outerHeight();if(t&&(u.top!=t.top||u.left!=t.left||u.width!=e||u.height!=n)){u.top=t.top,u.left=t.left,u.width=e,u.height=n,A.css({top:t.top+n+"px",left:t.left});var a=A.outerWidth()-A.width();A.width(e-a);var o=V.width(),i=V.height();V.css({top:t.top+(n-i)/2-1,left:t.left+e-o-2})}}function s(e){if(!(e.which>8&&e.which<46)){if(r.data(G,!1),!m("open_before"))return void f();T(null);var n=r.val();if(!t.trim(n))return _(!1),void f();var a=j(n);if(!m("send_before",a))return void f();b(),m("send"),I("source")(a,function(e){return m("receive"),r.is(":focus")?t.trim(r.val())&&e.length?(o(e,a),u(),w(),A.slideDown(50),void m("open")):(w(),T(null),void f()):(w(),void f())})}}function f(){m("close_before")&&(A.empty().hide(),m("close"))}function p(t){var e=A.find("li.active");switch(t.which){case c.up:e.length?(e.removeClass("active"),e.prev().length&&(e=e.prev())):e=A.find("li").last(),function(){var t=A.scrollTop(),n=A.offset(),r=e.outerHeight(),a=e.offset();a.top-n.top<0&&A.scrollTop(t-r)}(),e.addClass("active"),h();break;case c.down:e.length?(e.removeClass("active"),e.next().length&&(e=e.next())):e=A.find("li").first(),e.length&&!function(){var t=A.scrollTop(),n=A.height(),r=A.offset(),a=e.outerHeight(),o=e.offset();o.top-r.top+a>n&&A.scrollTop(t+a)}(),e.addClass("active"),h();break;case c.enter:f()}}function v(e){var n=t(e);n.is("a")&&(n=n.parents("li")),n.addClass("active"),h(),f()}function h(){if(m("select_before")){var t=A.find(".active a");t.length&&(r.val(t.attr("data-val")).data(G,!0),_(!1),T(t.data("kladr-object")),m("select",I("current")))}}function g(){function e(t,e){_(e),T(t)}if(I("verify")&&m("check_before")){var n=t.trim(r.val());if(!n)return void e(null,!1);if(I("current"))return void _(!1);var a=j(n);if(a.withParents=!1,a.limit=10,!m("send_before",a))return e(null,!1),void m("check",null);b(),m("send"),I("source")(a,function(n){function o(t,n){w(),e(t,n)}if(m("receive"),!t.trim(r.val()))return void o(null,!1);for(var i=a.name.toLowerCase(),l=null,u=null,s=0;s<n.length;s++)if(l=n[s].name.toLowerCase(),i==l){u=n[s];break}u&&r.val(I("valueFormat")(u,a)),o(u,!u),m("check",u)})}}function y(){function e(){r.attr(o,!0)}function n(t,e){t?r.val(I("valueFormat")(t,e)):_(!0),T(t),r.removeAttr(o)}var a={setValue:function(e){return"object"===t.type(e)?a.setValueByObject(e):"number"===t.type(e)?a.setValueById(e):"string"===t.type(e)?a.setValueByName(e):e?a:a.clear()},setValueByName:function(r){if(r=t.trim(r+"")){var o=j("");if(o.name=S(r),o.withParents=!1,o.limit=10,!m("send_before",o))return n(null,o),a;e(),m("send"),I("source")(o,function(t){m("receive");for(var e=o.name.toLowerCase(),r=null,a=null,i=0;i<t.length;i++)if(r=t[i].name.toLowerCase(),e==r){a=t[i];break}n(a,o)})}return a},setValueById:function(r){var o=j("");return o.parentType=o.type,o.parentId=r,o.limit=1,e(),t.kladr.api(o,function(t){t.length?n(t[0],o):n(null,o)}),a},setValueByObject:function(t){return n(t,j("")),a},clear:function(){return n(null,null),a}},o="data-kladr-autofill-lock";B("controller",a)}function k(){function e(){var e=r.val();if(e){var n,a=j(e),o=a.type,i=a.parentType,l=t.kladr.type,u=!0,s=I("controller").setValueByName;return o==l.street&&i!=l.city&&(u=!1),o!=l.building||~t.inArray(i,[l.street,l.city])||(u=!1),n=r.attr("data-kladr-autofill-lock"),n&&I("current")&&u&&s(e),!!I("current")}return!1}var n=0;!function a(){++n>5||e()||setTimeout(a,100)}()}function m(e,n){if(!e)return!0;var a=e.replace(/_([a-z])/gi,function(t,e){return e.toUpperCase()});return r.trigger("kladr_"+e,n),"function"===t.type(I(a))?I(a).call(r.get(0),n)!==!1:!0}function b(){I("spinner")&&I("showSpinner")(V)}function w(){I("spinner")&&I("hideSpinner")(V)}function j(t){var e,n={},r=["token","key","type","typeCode","parentType","parentId","oneString","withParents","limit"];for(e=0;e<r.length;e++)n[r[e]]=I(r[e]);n.name=S(t);var a,o=I("parentInput");return o&&(a=C(o,n.type),a&&(n.parentType=a.type,n.parentId=a.id)),n.oneString&&(n.withParents=!0),n}function C(e,n){var r,a=t.kladr.getInputs(e),o=t.kladr.type,i={},u=null;a.each(function(){var e,n=t(this);(e=n.attr("data-kladr-id"))&&(i[n.attr("data-kladr-type")]=e)});for(r in o){if(r==n)return u;l(o,r)&&i[r]&&(u={type:r,id:i[r]})}return u}function S(t){for(var e="abcdefghijklmnopqrstuvwxyz",n=t.toLowerCase(),r=0;r<n.length;r++)if(~e.indexOf(n[r]))return _(!0),t;return _(!1),t}function T(t){var e=I("current");(e&&e.id)!==(t&&t.id)&&(B("current",t),t&&t.id?r.attr("data-kladr-id",t.id):r.removeAttr("data-kladr-id"),I("oneString")&&t&&t.contentType&&r.attr("data-kladr-type",t.contentType),m("change",t))}function _(t){t?r.addClass("kladr-error"):r.removeClass("kladr-error")}function I(t){return d._get(t)}function B(t,e){d._set(t,e)}var A=null,V=null,x=".kladr",G="kladrInputChange";a(function(){var n=!1,a=!0,o="";r.attr("data-kladr-type",I("type")||"").attr("data-kladr-one-string",I("oneString")||null).on("keyup"+x,s).on("keydown"+x,p).on("blur"+x,function(){!n&&r.data(G)&&o!=r.val()&&r.change()}).on("blur"+x+" change"+x,function(t){return n?void 0:("change"==t.type&&(o=r.val()),a&&(a=!1,g()),f(),!1)}).on("focus"+x,function(){a=!0}),A.on("touchstart"+x+" mousedown"+x,"li, a",function(t){t.preventDefault(),n=!0,v(this),n=!1}),t(e).on("resize"+x,u)})})}function o(e,n){var a={obj:!1,str:!1,isGet:!1};return"object"===t.type(e)?(a.obj=e,a):("string"===t.type(e)&&(a.str=[e,n],a.isGet=n===r),a)}function i(){return i.guid?++i.guid:i.guid=1}function l(t,e){return t.hasOwnProperty(e)}var u={token:null,key:null,type:null,typeCode:null,parentType:null,parentId:null,limit:10,oneString:!1,withParents:!1,parentInput:null,verify:!1,spinner:!0,open:null,close:null,send:null,receive:null,select:null,check:null,change:null,openBefore:null,closeBefore:null,sendBefore:null,selectBefore:null,checkBefore:null,source:function(e,n){t.kladr.api(e,n)},labelFormat:function(e,n){var r;if(n.oneString)return e.parents?(r=[].concat(e.parents),r.push(e),t.kladr.buildAddress(r)):(e.typeShort?e.typeShort+". ":"")+e.name;var a,o,i,l,u="";return e.typeShort&&(u+=e.typeShort+". "),a=e.name,o=a.toLowerCase(),i=n.name.toLowerCase(),l=o.indexOf(i),l=~l?l:0,i.length<o.length?(u+=a.substr(0,l),u+="<strong>",u+=a.substr(l,i.length),u+="</strong>",u+=a.substr(l+i.length)):u+="<strong>"+a+"</strong>",u},valueFormat:function(e,n){var r;return n.oneString?e.parents?(r=[].concat(e.parents),r.push(e),t.kladr.buildAddress(r)):(e.typeShort?e.typeShort+". ":"")+e.name:e.name},showSpinner:function(t){var e=-.2,n=setInterval(function(){return t.is(":visible")?(t.css("background-position","0% "+e+"%"),e+=5.555556,void(e>95&&(e=-.2))):(clearInterval(n),void(n=null))},30);t.show()},hideSpinner:function(t){t.hide()}},s={current:null,controller:null},c={up:38,down:40,enter:13};t.kladr=t.extend(t.kladr,{setDefault:function(t,e){var n=o(t,e);if(n.obj)for(var r in n.obj)l(u,r)&&(u[r]=n.obj[r]);else n.str&&!n.isGet&&l(u,n.str[0])&&(u[n.str[0]]=n.str[1])},getDefault:function(t){return l(u,t)?u[t]:void 0},getInputs:function(e){var r=t(e||n.body),a="[data-kladr-type]";return r.filter(a).add(r.find(a))},setValues:function(e,n){var r,a,o="kladr_change.setvalues",i=t.kladr.type,u={},s=[];if(~t.inArray(t.type(e),["object","array"])){t.each(e,function(t,e){if(e){var n=e.contentType||e.type||t;l(i,n)&&(u[n]=e)}});for(a in i)l(i,a)&&u[a]&&(s[a]=u[a]);r=t.kladr.getInputs(n),function c(){var t,e,n;for(e in s)if(l(s,e)){n=s[e],delete s[e];break}if(e)return t=r.filter('[data-kladr-type="'+e+'"]'),t.length?void t.on(o,function(){t.off(o),c()}).kladr("controller").setValue(n):void c()}()}},getAddress:function(e,n){var r,a=t.kladr.getInputs(e),o=t.kladr.type,i={},u={};a.each(function(){var e,n,r,a=t(this);if(a.attr("data-kladr-id"))if(e=a.kladr("current"),a.attr("data-kladr-one-string")&&e.parents)for(n=[].concat(e.parents),n.push(e),r=0;r<n.length;r++)i[n[r].contentType]=n[r];else i[a.attr("data-kladr-type")]=e;else i[a.attr("data-kladr-type")]=a.val()});for(r in o)l(o,r)&&i[r]&&(u[r]=i[r]);return(n||t.kladr.buildAddress)(u)},buildAddress:function(e){var n=[],r="",a="";return t.each(e,function(e,o){var i,l="",u="";if("object"===t.type(o)){for(i=0;i<n.length;i++)if(n[i]==o.id)return;n.push(o.id),l=o.name,u=o.typeShort+". ",a=o.zip||a}else l=o;r&&(r+=", "),r+=u+l}),r=(a?a+", ":"")+r}}),t.fn.kladr=function(e,n){var r=o(e,n),i=null;return this.each(function(){var e=a(t(this),r);return r.isGet?(i=e,!1):void 0}),r.isGet?i:this}}(jQuery,window,document);