define(["jquery","underscore","yandexmaps","mustache"],function(a,e,n){function t(a){a.preventDefault(),p()}function s(e){e.preventDefault();var n=a(this).data("partnerSlug");a(this).hasClass("selected")?(a(this).removeClass("selected"),v[n]=!1):(a(this).addClass("selected"),v[n]=!0),p({partners:i()})}function o(){var a=55.72504493,e=37.646961;"geolocation"in navigator&&navigator.geolocation.getCurrentPosition(function(n){a=n.coords.latitude,e=n.coords.longitude}),c=new n.Map("map",{center:[a,e],zoom:10,controls:[]}),c.container.fitToViewport(),u=new n.GeoObjectCollection,p()}function i(){var a=[];return e.each(v,function(e,n){e&&a.push(n)}),a}function r(e){var n=e||{};a.ajax({url:"/ajax/get-shops",data:n,type:"POST",beforeSend:function(){u&&u.removeAll()},success:function(a){if(a.data.mapCenter){var e=a.data.mapCenter||!1;c.setCenter([e.latitude,e.longitude])}l(a.data.points)}})}function p(a){f.val().length>0&&(h.phrase=f.val()+" "+b),void 0!==a&&a.partners&&(h.partners=a.partners),h.redirectTo=window.location.pathname||!1,r(h)}function l(a){for(var e=0;e<a.length;e++){var t=a[e],s={pointName:t.name,pointLogo:t.logo,pointAddress:t.address,pointLink:t.link,subway:[]};if(t.subway)for(var o in t.subway)null!==t.subway[o].line&&null!==t.subway[o].name&&s.subway.push({color:t.subway[o].line?t.subway[o].line.color:!1,station:t.subway[o].name});var i=n.templateLayoutFactory.createClass('<div class="map-baloon clearfix"><div class="shop-snippet"><div class="shop-snippet-name"><img src="{{properties.pointLogo}}" alt="" class="shop-snippet-name__img"><span class="shop-snippet-name__text">{{properties.pointName}}</span></div><div class="shop-snippet-info">{% for subway in properties.subway %}{{#subway}}<div class="shop-snippet-metro"><span class="shop-snippet-metro__bullet" style="background:{{subway.color}}"></span><span class="shop-snippet-metro__text">м. {{subway.station}}</span></div>{{/subway}}{% endfor %}<div class="shop-snippet-address">{{properties.pointAddress}}</div></div></div><a class="shop-snippet__more" href="{{properties.pointLink}}">Подробнее</a>');u.add(new n.Placemark([t.latitude,t.longitude],s,{iconLayout:"default#image",iconImageHref:t.marker,balloonContentLayout:i,balloonPanelMaxMapArea:0}))}c.geoObjects.add(u)}var c,u,d=a(".js-search-points-form"),f=a(".js-search-points-input"),m=a(".js-partner-icon"),v={},h={},b=a("body").data("config").region.name;d.on("submit",t),m.on("click",s),n.ready(o),function(){m.each(function(){v[a(this).data("partnerSlug")]=!1})}()});