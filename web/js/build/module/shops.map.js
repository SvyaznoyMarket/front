define(["jquery","underscore","yandexmaps","mustache"],function(a,e,n,t){function o(a){a.preventDefault(),l()}function s(e){e.preventDefault();var n=a(this).data("partnerSlug");a(this).hasClass("selected")?(a(this).removeClass("selected"),v[n]=!1):(a(this).addClass("selected"),v[n]=!0),l({partners:r()})}function i(){var a=55.72504493,e=37.646961;"geolocation"in navigator&&navigator.geolocation.getCurrentPosition(function(n){a=n.coords.latitude,e=n.coords.longitude}),u=new n.Map("map",{center:[a,e],zoom:10,controls:["zoomControl","geolocationControl"]}),u.container.fitToViewport(),d=new n.GeoObjectCollection,l({},!0)}function r(){var a=[];return e.each(v,function(e,n){e&&a.push(n)}),a}function p(e,n){var t=e||{};a.ajax({url:"/ajax/get-shops",data:t,type:"POST",success:function(a){if(a.data.mapCenter){var e=a.data.mapCenter||!1;u.setCenter([e.latitude,e.longitude])}n?c(a.data.points):u.setZoom(14)}})}function l(a,e){f.val().length>0&&(g.phrase=f.val()+" "+y),void 0!==a&&a.partners&&(g.partners=a.partners),g.redirectTo=window.location.pathname||!1,p(g,e||!1)}function c(a){for(var e=0;e<a.length;e++){var t=a[e],o={pointName:t.name,pointLogo:t.logo,pointAddress:t.address,pointLink:t.link,subway:[]};if(t.subway)for(var s in t.subway)null!==t.subway[s].line&&null!==t.subway[s].name&&o.subway.push({color:t.subway[s].line?t.subway[s].line.color:!1,station:t.subway[s].name});var i=n.templateLayoutFactory.createClass('<div class="map-baloon clearfix"><div class="shop-snippet"><div class="shop-snippet-name"><img src="{{properties.pointLogo}}" alt="" class="shop-snippet-name__img"><span class="shop-snippet-name__text">{{properties.pointName}}</span></div><div class="shop-snippet-info">{% for subway in properties.subway %}{{#subway}}<div class="shop-snippet-metro"><span class="shop-snippet-metro__bullet" style="background:{{subway.color}}"></span><span class="shop-snippet-metro__text">м. {{subway.station}}</span></div>{{/subway}}{% endfor %}<div class="shop-snippet-address">{{properties.pointAddress}}</div></div></div><a class="shop-snippet__more" href="{{properties.pointLink}}">Подробнее</a>');t.latitude&&t.longitude&&d.add(new n.Placemark([t.latitude,t.longitude],o,{iconLayout:"default#image",iconImageHref:t.marker,balloonContentLayout:i,balloonPanelMaxMapArea:0,hideIconOnBalloonOpen:!1}))}u.geoObjects.add(d)}var u,d,m=a(".js-search-points-form"),f=a(".js-search-points-input"),h=a(".js-partner-icon"),v={},g={},y=a("body").data("config").region.name;m.on("submit",o),h.on("click",s),n.ready(i),function(){h.each(function(){v[a(this).data("partnerSlug")]=!1})}()});