define(["jquery","underscore","yandexmaps","mustache"],function(a,e,n){function t(a){a.preventDefault(),p()}function o(e){e.preventDefault();var n=a(this).data("partnerSlug");a(this).hasClass("selected")?(a(this).removeClass("selected"),h[n]=!1):(a(this).addClass("selected"),h[n]=!0),p({partners:i()})}function s(){var a=55.72504493,e=37.646961;"geolocation"in navigator&&navigator.geolocation.getCurrentPosition(function(n){a=n.coords.latitude,e=n.coords.longitude}),c=new n.Map("map",{center:[a,e],zoom:10,controls:["zoomControl","geolocationControl"]}),c.container.fitToViewport(),u=new n.GeoObjectCollection,p({},!0)}function i(){var a=[];return e.each(h,function(e,n){e&&a.push(n)}),a}function r(e,n){var t=e||{};a.ajax({url:"/ajax/get-shops",data:t,type:"POST",success:function(a){if(a.data.mapCenter){var e=a.data.mapCenter||!1;c.setCenter([e.latitude,e.longitude])}n?l(a.data.points):c.setZoom(14)}})}function p(a,e){m.val().length>0&&(v.phrase=m.val()+" "+g),void 0!==a&&a.partners&&(v.partners=a.partners),v.redirectTo=window.location.pathname||!1,r(v,e||!1)}function l(a){for(var e=0;e<a.length;e++){var t=a[e],o={pointName:t.name,pointLogo:t.logo,pointAddress:t.address,pointLink:t.link,subway:[]};if(t.subway)for(var s in t.subway)null!==t.subway[s].line&&null!==t.subway[s].name&&o.subway.push({color:t.subway[s].line?t.subway[s].line.color:!1,station:t.subway[s].name});var i=n.templateLayoutFactory.createClass('<div class="map-baloon clearfix"><div class="shop-snippet"><div class="shop-snippet-name"><img src="{{properties.pointLogo}}" alt="" class="shop-snippet-name__img"><span class="shop-snippet-name__text">{{properties.pointName}}</span></div><div class="shop-snippet-info">{% for subway in properties.subway %}{{#subway}}<div class="shop-snippet-metro"><span class="shop-snippet-metro__bullet" style="background:{{subway.color}}"></span><span class="shop-snippet-metro__text">м. {{subway.station}}</span></div>{{/subway}}{% endfor %}<div class="shop-snippet-address">{{properties.pointAddress}}</div></div></div><a class="shop-snippet__more" href="{{properties.pointLink}}">Подробнее</a>');t.latitude&&t.longitude&&u.add(new n.Placemark([t.latitude,t.longitude],o,{iconLayout:"default#image",iconImageHref:t.marker,balloonContentLayout:i,balloonPanelMaxMapArea:0,hideIconOnBalloonOpen:!1}))}c.geoObjects.add(u)}var c,u,d=a(".js-search-points-form"),m=a(".js-search-points-input"),f=a(".js-partner-icon"),h={},v={},g=a("body").data("config").region.name;d.on("submit",t),f.on("click",o),n.ready(s),function(){f.each(function(){h[a(this).data("partnerSlug")]=!1})}()});