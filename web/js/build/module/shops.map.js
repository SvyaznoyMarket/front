define(["jquery","underscore","yandexmaps","mustache"],function(a,e,n,t){function s(a){a.preventDefault(),l()}function o(e){e.preventDefault();var n=a(this).data("partnerSlug");a(this).hasClass("selected")?(a(this).removeClass("selected"),h[n]=!1):(a(this).addClass("selected"),h[n]=!0),l({partners:r()})}function i(){var a=55.72504493,e=37.646961;"geolocation"in navigator&&navigator.geolocation.getCurrentPosition(function(n){a=n.coords.latitude,e=n.coords.longitude}),u=new n.Map("map",{center:[a,e],zoom:10,controls:[]}),u.container.fitToViewport(),d=new n.GeoObjectCollection,l()}function r(){var a=[];return e.each(h,function(e,n){e&&a.push(n)}),a}function p(e){var n=e||{};a.ajax({url:"/ajax/get-shops",data:n,type:"POST",beforeSend:function(){d&&d.removeAll()},success:function(a){if(a.data.mapCenter){var e=a.data.mapCenter||!1;u.setCenter([e.latitude,e.longitude])}c(a.data.points)}})}function l(a){m.val().length>0&&(b.phrase=m.val()+" "+y),void 0!==a&&a.partners&&(b.partners=a.partners),b.redirectTo=window.location.pathname||!1,p(b)}function c(a){for(var e=0;e<a.length;e++){var t=a[e],s={pointName:t.name,pointLogo:t.logo,pointAddress:t.address,pointLink:t.link,subway:[]};if(t.subway)for(var o in t.subway)null!==t.subway[o].line&&null!==t.subway[o].name&&s.subway.push({color:t.subway[o].line?t.subway[o].line.color:!1,station:t.subway[o].name});var i=n.templateLayoutFactory.createClass('<div class="map-baloon clearfix"><div class="shop-snippet"><div class="shop-snippet-name"><img src="{{properties.pointLogo}}" alt="" class="shop-snippet-name__img"><span class="shop-snippet-name__text">{{properties.pointName}}</span></div><div class="shop-snippet-info">{% for subway in properties.subway %}{{#subway}}<div class="shop-snippet-metro"><span class="shop-snippet-metro__bullet" style="background:{{subway.color}}"></span><span class="shop-snippet-metro__text">м. {{subway.station}}</span></div>{{/subway}}{% endfor %}<div class="shop-snippet-address">{{properties.pointAddress}}</div></div></div><a class="shop-snippet__more" href="{{properties.pointLink}}">Подробнее</a>');d.add(new n.Placemark([t.latitude,t.longitude],s,{iconLayout:"default#image",iconImageHref:t.marker,balloonContentLayout:i,balloonPanelMaxMapArea:0}))}u.geoObjects.add(d)}var u,d,f=a(".js-search-points-form"),m=a(".js-search-points-input"),v=a(".js-partner-icon"),h={},b={},y=a("body").data("config").region.name;f.on("submit",s),v.on("click",o),n.ready(i),function(){v.each(function(){h[a(this).data("partnerSlug")]=!1})}()});