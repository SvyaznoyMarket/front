define(["jquery","underscore","module/config","module/widget"],function(t,e,r){var n=t("body"),a=function(a){a.stopPropagation();var o=t(a.target),i=o.data(),c=o.data("widgetSelector")?t(o.data("widgetSelector")):null;console.info("addProductToCart",{$el:o,$widget:c,data:i}),i.url&&(t.post(i.url,i.value,function(a){e.isObject(a.result.widgets)&&e.each(a.result.widgets,function(e,r){r&&t(r).trigger("render",e)}),t.extend(!0,a.products,i.value.product),n.trigger(r.event.productAddedToCart,t.extend(!0,{},i.value,{products:a.products})),t(".js-kit-close").trigger("click")}),a.preventDefault())},o=function(a){a.stopPropagation();var o=t(a.target),i=o.data(),c=t(o.data("spinnerSelector"));if(console.info("deleteProductFromCart",o,i),i.url&&(t.post(i.url,i.value,function(a){if(a.redirect&&-1!==a.redirect.indexOf("/")&&(window.location.href=a.redirect),e.isObject(a.result)&&e.isObject(a.result.widgets)&&e.each(a.result.widgets,function(e,r){r&&t(r).trigger("render",e)}),o.data("parentContainerSelector")){var c=o.parents(o.data("parentContainerSelector"));c.length&&c.slideUp(300,function(){c.remove()})}t.extend(!0,a.products[i.value.product.id],i.value.product),n.trigger(r.event.productRemovedFromCart,t.extend(!0,{},i.value,{products:a.products}))}),a.preventDefault(),c.length)){var u=c.data("timer");try{clearTimeout(u)}catch(d){console.warn(d)}}},i=function(r,n,o,i,c){r.stopPropagation();var u=t(r.target),d=t(u),l=d.data("value"),s=t(d.data("widgetSelector")),p=parseInt(s.data("timer")),i=i||null,g=function(r,a){if(a||!e.isFinite(r)||r<n.minQuantity||r>999){var a=a||{code:"invalid",message:"Неверное количество товара"};return console.info("changeProductQuantityData:js-buyButton",a,r,d),c&&c(a),!1}l.product[n.id]&&(l.product[n.id].quantity=r),c&&c(),t(".js-productKit-reset").prop("checked",!1)};if(console.info("changeProductQuantity",{$el:d,$widget:s,product:n,quantity:o,checkUrl:i}),i)t.post(i,{products:[{id:n.id,quantity:o}]}).done(function(t){t.success?g(o):g(n.quantity,{code:"invalid",message:"Невозможно установить такое количество"})});else{if("on"==d.data("autoUpdate")&&e.isFinite(p)&&p>0){try{clearTimeout(p)}catch(v){console.warn(v)}p=setTimeout(function(){a(r)},600),s.data("timer",p)}g(o)}if(d.hasClass("js-quickBuyButton")){var f=d.attr("href").replace(/\d+$/,o);d.attr("href",f)}},c=function(e){e.stopPropagation();var r=t(e.target),n=t(r.data("widgetSelector")),a=t(r.data("buttonSelector")),o=t(r.data("valueSelector")),i=a.data("value"),c=o.data("value");console.info("incSpinnerValue",{$el:r,$target:a,$value:o,$widget:n});var u=i&&c?i.product[c.product.id]:null;u?a.trigger("changeProductQuantityData",[c.product,u.quantity+1,c.checkUrl,function(t){n.trigger("renderValue",[u]),t&&n.find(".js-buySpinner-inc").css({opacity:.5})}]):console.error("Товар не получен",u),r.blur()},u=function(e){e.stopPropagation();var r=t(e.target),n=t(r.data("widgetSelector")),a=t(r.data("buttonSelector")),o=t(r.data("valueSelector")),i=a.data("value"),c=o.data("value");console.info("decSpinnerValue",{$el:r,$target:a,$value:o,$widget:n});var u=i&&c?i.product[c.product.id]:null;u?a.trigger("changeProductQuantityData",[c.product,u.quantity-1,c.checkUrl,function(){n.trigger("renderValue",[u]),n.find(".js-buySpinner-inc").css({opacity:1})}]):console.error("Товар не получен",u),r.blur()},d=function(e){e.stopPropagation();var r=t(e.target),n=t(r.data("widgetSelector")),a=t(r.data("buttonSelector")),o=a.data("value"),i=r.data("value");console.info("changeSpinnerValue",{$el:r,$target:a,$widget:n});var c=r.val(),u=o&&i?o.product[i.product.id]:null;""!=c&&u&&a.trigger("changeProductQuantityData",[i.product,parseInt(c),i.checkUrl,function(){n.trigger("renderValue",[u]),n.find(".js-buySpinner-inc").css({opacity:1})}])},l=function(e,r){e.stopPropagation();var n=t(e.target);console.info("renderSpinnerValue",n,r),n.find(".js-buySpinner-value").val(r.quantity)},s=function(e){e.stopPropagation();var n=t(e.target);n.is(":checked")?t.cookie(r.credit.cookieName,1,{expires:7}):t.removeCookie(r.credit.cookieName),e.preventDefault()},p=function(e){e.stopPropagation(),t.removeCookie(r.credit.cookieName),e.preventDefault()},g=function(e){1==t.cookie(r.credit.cookieName)?e.attr("checked",!0):e.removeAttr("checked")};return n.on("click",".js-buyButton",a).on("changeProductQuantityData",".js-buyButton",i).on("changeProductQuantityData",".js-quickBuyButton",i).on("click",".js-deleteButton",o),n.on("click dblclick contextmenu",".js-buySpinner-inc",c).on("click dblclick contextmenu",".js-buySpinner-dec",u).on("change keyup",".js-buySpinner-value",d).on("renderValue",".js-buySpinner",l).on("changeProductQuantityData",".js-buySpinner-value",i),n.on("change",".js-creditButton",s).on("change",".js-creditButton-remove",p),g(t(".js-creditButton")),{initCredit:function(){g(t(".js-creditButton"))}}});