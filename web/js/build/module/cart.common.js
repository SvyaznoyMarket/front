define(["jquery","underscore","module/config","module/widget"],function(t,e,n){var r=t("body"),a=function(a){a.stopPropagation();var o=t(a.target),i=o.data(),c=t(o.data("widgetSelector"));console.info("addProductToCart",o,c,i),i.url&&(t.post(i.url,i.value,function(a){e.isObject(a.result.widgets)&&e.each(a.result.widgets,function(e,n){n&&t(n).trigger("render",e)}),r.trigger(n.event.productAddedToCart,i.value)}),a.preventDefault())},o=function(a){a.stopPropagation();var o=t(a.target),i=o.data(),c=t(o.data("spinnerSelector"));if(console.info("deleteProductFromCart",o,i),i.url){if(t.post(i.url,i.value,function(n){if(n.redirect&&-1!==n.redirect.indexOf("/")&&(window.location.href=n.redirect),e.isObject(n.result)&&e.isObject(n.result.widgets)&&e.each(n.result.widgets,function(e,n){n&&t(n).trigger("render",e)}),o.data("parentContainerSelector")){var r=o.parents(o.data("parentContainerSelector"));r.length&&r.slideUp(300,function(){r.remove()})}}),a.preventDefault(),c.length){var u=c.data("timer");try{clearTimeout(u)}catch(d){console.warn(d)}}r.trigger(n.event.productRemovedFromCart,i.value)}},i=function(n,r){n.stopPropagation();var o=t(n.target),i=t(o),c=i.data("value"),u=t(i.data("widgetSelector")),d=parseInt(u.data("timer"));if(console.info("changeProductQuantity",i,r),e.isFinite(d)&&d>0){try{clearTimeout(d)}catch(l){console.warn(l)}d=setTimeout(function(){a(n)},600),u.data("timer",d)}if(!e.isFinite(r)||0>=r||r>999){var l={code:"invalid",message:"Неверное количество товара"};return console.info("changeProductQuantityData:js-buyButton",l,r,i),l}if(c.product.quantity=r,i.hasClass("js-quickBuyButton")){var s=i.attr("href").replace(/\d+$/,r);i.attr("href",s)}},c=function(e){e.stopPropagation();var n=t(e.target),r=t(n.data("widgetSelector")),a=t(n.data("buttonSelector")),o=a.data("value");console.info("incSpinnerValue",n,a,r),o&&(a.trigger("changeProductQuantityData",o.product.quantity+1),r.trigger("renderValue",o.product)),n.blur()},u=function(e){e.stopPropagation();var n=t(e.target),r=t(n.data("widgetSelector")),a=t(n.data("buttonSelector")),o=a.data("value");console.info("decSpinnerValue",n,a),o&&(a.trigger("changeProductQuantityData",o.product.quantity-1),r.trigger("renderValue",o.product)),n.blur()},d=function(e){e.stopPropagation();var n=t(e.target),r=t(n.data("widgetSelector")),a=t(n.data("buttonSelector")),o=a.data("value");console.info("changeSpinnerValue",n,a);var i=n.val();""!=i&&(a.trigger("changeProductQuantityData",parseInt(i)),o&&r.trigger("renderValue",o.product))},l=function(e,n){e.stopPropagation();var r=t(e.target);console.info("renderSpinnerValue",r,n),r.find(".js-buySpinner-value").val(n.quantity)},s=function(e){e.stopPropagation();var r=t(e.target);r.is(":checked")?t.cookie(n.credit.cookieName,1,{expires:7}):t.removeCookie(n.credit.cookieName),e.preventDefault()},g=function(e){e.stopPropagation(),t.removeCookie(n.credit.cookieName),e.preventDefault()},p=function(e){1==t.cookie(n.credit.cookieName)?e.attr("checked",!0):e.removeAttr("checked")};return r.on("click",".js-buyButton",a).on("changeProductQuantityData",".js-buyButton",i).on("changeProductQuantityData",".js-quickBuyButton",i).on("click",".js-deleteButton",o),r.on("click dblclick contextmenu",".js-buySpinner-inc",c).on("click dblclick contextmenu",".js-buySpinner-dec",u).on("change keyup",".js-buySpinner-value",d).on("renderValue",".js-buySpinner",l).on("changeProductQuantityData",".js-buySpinner-value",i),r.on("change",".js-creditButton",s).on("change",".js-creditButton-remove",g),p(t(".js-creditButton")),{initCredit:function(){p(t(".js-creditButton"))}}});