define(["jquery","underscore","module/config","module/widget"],function(t,e,a){var r=t("body"),n=function(n){n.stopPropagation();var o=t(n.target),i=o.data(),c=o.data("widgetSelector")?t(o.data("widgetSelector")):null;console.info("addProductToCart",{$el:o,$widget:c,data:i}),i.url&&(t.post(i.url,i.value,function(n){e.isObject(n.result.widgets)&&e.each(n.result.widgets,function(e,a){a&&t(a).trigger("render",e)}),r.trigger(a.event.productAddedToCart,i.value),t(".js-kit-close").trigger("click")}),n.preventDefault())},o=function(n){n.stopPropagation();var o=t(n.target),i=o.data(),c=t(o.data("spinnerSelector"));if(console.info("deleteProductFromCart",o,i),i.url){if(t.post(i.url,i.value,function(a){if(a.redirect&&-1!==a.redirect.indexOf("/")&&(window.location.href=a.redirect),e.isObject(a.result)&&e.isObject(a.result.widgets)&&e.each(a.result.widgets,function(e,a){a&&t(a).trigger("render",e)}),o.data("parentContainerSelector")){var r=o.parents(o.data("parentContainerSelector"));r.length&&r.slideUp(300,function(){r.remove()})}}),n.preventDefault(),c.length){var u=c.data("timer");try{clearTimeout(u)}catch(d){console.warn(d)}}r.trigger(a.event.productRemovedFromCart,i.value)}},i=function(a,r,o){a.stopPropagation();var i=t(a.target),c=t(i),u=c.data("value"),d=t(c.data("widgetSelector")),l=parseInt(d.data("timer"));if(console.info("changeProductQuantity",{$el:c,product:r,quantity:o}),"on"==c.data("autoUpdate")&&e.isFinite(l)&&l>0){try{clearTimeout(l)}catch(g){console.warn(g)}l=setTimeout(function(){n(a)},600),d.data("timer",l)}if(!e.isFinite(o)||0>=o||o>999){var g={code:"invalid",message:"Неверное количество товара"};return console.info("changeProductQuantityData:js-buyButton",g,o,c),g}if(u.product[r.id]&&(u.product[r.id].quantity=o),c.hasClass("js-quickBuyButton")){var s=c.attr("href").replace(/\d+$/,o);c.attr("href",s)}},c=function(e){e.stopPropagation();var a=t(e.target),r=t(a.data("widgetSelector")),n=t(a.data("buttonSelector")),o=t(a.data("valueSelector")),i=n.data("value"),c=o.data("value");console.info("incSpinnerValue",{$el:a,$target:n,$value:o,$widget:r});var u=i&&c?i.product[c.product.id]:null;u?(n.trigger("changeProductQuantityData",[u,u.quantity+1]),r.trigger("renderValue",[u])):console.error("Товар не получен",u),a.blur()},u=function(e){e.stopPropagation();var a=t(e.target),r=t(a.data("widgetSelector")),n=t(a.data("buttonSelector")),o=t(a.data("valueSelector")),i=n.data("value"),c=o.data("value");console.info("incSpinnerValue",{$el:a,$target:n,$value:o,$widget:r});var u=i&&c?i.product[c.product.id]:null;u?(n.trigger("changeProductQuantityData",[u,u.quantity-1]),r.trigger("renderValue",[u])):console.error("Товар не получен",u),a.blur()},d=function(e){e.stopPropagation();var a=t(e.target),r=t(a.data("widgetSelector")),n=t(a.data("buttonSelector")),o=n.data("value"),i=a.data("value");console.info("changeSpinnerValue",{$el:a,$target:n,$widget:r});var c=a.val();if(""!=c){var u=o&&i?o.product[i.product.id]:null;u&&n.trigger("changeProductQuantityData",[u,parseInt(c)]),r.trigger("renderValue",[u])}},l=function(e,a){e.stopPropagation();var r=t(e.target);console.info("renderSpinnerValue",r,a),r.find(".js-buySpinner-value").val(a.quantity)},g=function(e){e.stopPropagation();var r=t(e.target);r.is(":checked")?t.cookie(a.credit.cookieName,1,{expires:7}):t.removeCookie(a.credit.cookieName),e.preventDefault()},s=function(e){e.stopPropagation(),t.removeCookie(a.credit.cookieName),e.preventDefault()},p=function(e){1==t.cookie(a.credit.cookieName)?e.attr("checked",!0):e.removeAttr("checked")};return r.on("click",".js-buyButton",n).on("changeProductQuantityData",".js-buyButton",i).on("changeProductQuantityData",".js-quickBuyButton",i).on("click",".js-deleteButton",o),r.on("click dblclick contextmenu",".js-buySpinner-inc",c).on("click dblclick contextmenu",".js-buySpinner-dec",u).on("change keyup",".js-buySpinner-value",d).on("renderValue",".js-buySpinner",l).on("changeProductQuantityData",".js-buySpinner-value",i),r.on("change",".js-creditButton",g).on("change",".js-creditButton-remove",s),p(t(".js-creditButton")),{initCredit:function(){p(t(".js-creditButton"))}}});