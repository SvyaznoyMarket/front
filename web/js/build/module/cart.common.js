define(["jquery","underscore","module/config","module/widget"],function(t,e,n){var a=t("body"),r=function(r){r.stopPropagation();var o=t(r.target),i=o.data(),c=o.data("widgetSelector")?t(o.data("widgetSelector")):null;console.info("addProductToCart",{$el:o,$widget:c,data:i}),i.url&&(t.post(i.url,i.value,function(r){e.isObject(r.result.widgets)&&e.each(r.result.widgets,function(e,n){n&&t(n).trigger("render",e)}),a.trigger(n.event.productAddedToCart,i.value),t(".js-kit-close").trigger("click")}),r.preventDefault())},o=function(r){r.stopPropagation();var o=t(r.target),i=o.data(),c=t(o.data("spinnerSelector"));if(console.info("deleteProductFromCart",o,i),i.url){if(t.post(i.url,i.value,function(n){if(n.redirect&&-1!==n.redirect.indexOf("/")&&(window.location.href=n.redirect),e.isObject(n.result)&&e.isObject(n.result.widgets)&&e.each(n.result.widgets,function(e,n){n&&t(n).trigger("render",e)}),o.data("parentContainerSelector")){var a=o.parents(o.data("parentContainerSelector"));a.length&&a.slideUp(300,function(){a.remove()})}}),r.preventDefault(),c.length){var u=c.data("timer");try{clearTimeout(u)}catch(d){console.warn(d)}}a.trigger(n.event.productRemovedFromCart,i.value)}},i=function(n,a,o,i,c){n.stopPropagation();var u=t(n.target),d=t(u),l=d.data("value"),s=t(d.data("widgetSelector")),g=parseInt(s.data("timer")),i=i||null,p=function(n,r){if(r||!e.isFinite(n)||n<a.minQuantity||n>999){var r=r||{code:"invalid",message:"Неверное количество товара"};return console.info("changeProductQuantityData:js-buyButton",r,n,d),c&&c(r),!1}l.product[a.id]&&(l.product[a.id].quantity=n),c&&c(),t(".js-productKit-reset").prop("checked",!1)};if(console.info("changeProductQuantity",{$el:d,$widget:s,product:a,quantity:o,checkUrl:i}),i)t.post(i,{products:[{id:a.id,quantity:o}]}).done(function(t){t.success?p(o):p(a.quantity,{code:"invalid",message:"Невозможно установить такое количество"})});else{if("on"==d.data("autoUpdate")&&e.isFinite(g)&&g>0){try{clearTimeout(g)}catch(f){console.warn(f)}g=setTimeout(function(){r(n)},600),s.data("timer",g)}p(o)}if(d.hasClass("js-quickBuyButton")){var v=d.attr("href").replace(/\d+$/,o);d.attr("href",v)}},c=function(e){e.stopPropagation();var n=t(e.target),a=t(n.data("widgetSelector")),r=t(n.data("buttonSelector")),o=t(n.data("valueSelector")),i=r.data("value"),c=o.data("value");console.info("incSpinnerValue",{$el:n,$target:r,$value:o,$widget:a});var u=i&&c?i.product[c.product.id]:null;u?r.trigger("changeProductQuantityData",[c.product,u.quantity+1,c.checkUrl,function(t){a.trigger("renderValue",[u]),t&&a.find(".js-buySpinner-inc").css({opacity:.5})}]):console.error("Товар не получен",u),n.blur()},u=function(e){e.stopPropagation();var n=t(e.target),a=t(n.data("widgetSelector")),r=t(n.data("buttonSelector")),o=t(n.data("valueSelector")),i=r.data("value"),c=o.data("value");console.info("incSpinnerValue",{$el:n,$target:r,$value:o,$widget:a});var u=i&&c?i.product[c.product.id]:null;u?r.trigger("changeProductQuantityData",[c.product,u.quantity-1,c.checkUrl,function(){a.trigger("renderValue",[u]),a.find(".js-buySpinner-inc").css({opacity:1})}]):console.error("Товар не получен",u),n.blur()},d=function(e){e.stopPropagation();var n=t(e.target),a=t(n.data("widgetSelector")),r=t(n.data("buttonSelector")),o=r.data("value"),i=n.data("value");console.info("changeSpinnerValue",{$el:n,$target:r,$widget:a});var c=n.val(),u=o&&i?o.product[i.product.id]:null;""!=c&&u&&r.trigger("changeProductQuantityData",[i.product,parseInt(c),i.checkUrl,function(){a.trigger("renderValue",[u]),a.find(".js-buySpinner-inc").css({opacity:1})}])},l=function(e,n){e.stopPropagation();var a=t(e.target);console.info("renderSpinnerValue",a,n),a.find(".js-buySpinner-value").val(n.quantity)},s=function(e){e.stopPropagation();var a=t(e.target);a.is(":checked")?t.cookie(n.credit.cookieName,1,{expires:7}):t.removeCookie(n.credit.cookieName),e.preventDefault()},g=function(e){e.stopPropagation(),t.removeCookie(n.credit.cookieName),e.preventDefault()},p=function(e){1==t.cookie(n.credit.cookieName)?e.attr("checked",!0):e.removeAttr("checked")};return a.on("click",".js-buyButton",r).on("changeProductQuantityData",".js-buyButton",i).on("changeProductQuantityData",".js-quickBuyButton",i).on("click",".js-deleteButton",o),a.on("click dblclick contextmenu",".js-buySpinner-inc",c).on("click dblclick contextmenu",".js-buySpinner-dec",u).on("change keyup",".js-buySpinner-value",d).on("renderValue",".js-buySpinner",l).on("changeProductQuantityData",".js-buySpinner-value",i),a.on("change",".js-creditButton",s).on("change",".js-creditButton-remove",g),p(t(".js-creditButton")),{initCredit:function(){p(t(".js-creditButton"))}}});