define(["jquery","underscore","module/config","module/widget"],function(t,e,a){var n=t("body"),r=function(r){r.stopPropagation();var o=t(r.target),i=o.data(),c=o.data("widgetSelector")?t(o.data("widgetSelector")):null,u=!1;console.info("addProductToCart",{$el:o,$widget:c,data:i});try{i.url&&e.each(i.value.product,function(t){t.wmId&&(window.WikimartAffiliate.addGoodToCart(t.wmId),o.text("В корзине"),o.attr("href","/cart"),o.data("url",null),u=!0)})}catch(d){console.error(d)}u&&r.preventDefault(),console.info({isWm:u}),!u&&i.url&&(t.post(i.url,i.value,function(r){e.isObject(r.result.widgets)&&e.each(r.result.widgets,function(e,a){a&&t(a).trigger("render",e)}),n.trigger(a.event.productAddedToCart,i.value),t(".js-kit-close").trigger("click")}),r.preventDefault())},o=function(r){r.stopPropagation();var o=t(r.target),i=o.data(),c=t(o.data("spinnerSelector"));if(console.info("deleteProductFromCart",o,i),i.url){if(t.post(i.url,i.value,function(a){if(a.redirect&&-1!==a.redirect.indexOf("/")&&(window.location.href=a.redirect),e.isObject(a.result)&&e.isObject(a.result.widgets)&&e.each(a.result.widgets,function(e,a){a&&t(a).trigger("render",e)}),o.data("parentContainerSelector")){var n=o.parents(o.data("parentContainerSelector"));n.length&&n.slideUp(300,function(){n.remove()})}}),r.preventDefault(),c.length){var u=c.data("timer");try{clearTimeout(u)}catch(d){console.warn(d)}}n.trigger(a.event.productRemovedFromCart,i.value)}},i=function(a,n,o,i,c){a.stopPropagation();var u=t(a.target),d=t(u),l=d.data("value"),s=t(d.data("widgetSelector")),g=parseInt(s.data("timer")),i=i||null,p=function(a,r){if(r||!e.isFinite(a)||a<n.minQuantity||a>999){var r=r||{code:"invalid",message:"Неверное количество товара"};return console.info("changeProductQuantityData:js-buyButton",r,a,d),c&&c(r),!1}l.product[n.id]&&(l.product[n.id].quantity=a),c&&c(),t(".js-productKit-reset").prop("checked",!1)};if(console.info("changeProductQuantity",{$el:d,$widget:s,product:n,quantity:o,checkUrl:i}),i)t.post(i,{products:[{id:n.id,quantity:o}]}).done(function(t){t.success?p(o):p(n.quantity,{code:"invalid",message:"Невозможно установить такое количество"})});else{if("on"==d.data("autoUpdate")&&e.isFinite(g)&&g>0){try{clearTimeout(g)}catch(f){console.warn(f)}g=setTimeout(function(){r(a)},600),s.data("timer",g)}p(o)}if(d.hasClass("js-quickBuyButton")){var v=d.attr("href").replace(/\d+$/,o);d.attr("href",v)}},c=function(e){e.stopPropagation();var a=t(e.target),n=t(a.data("widgetSelector")),r=t(a.data("buttonSelector")),o=t(a.data("valueSelector")),i=r.data("value"),c=o.data("value");console.info("incSpinnerValue",{$el:a,$target:r,$value:o,$widget:n});var u=i&&c?i.product[c.product.id]:null;u?r.trigger("changeProductQuantityData",[c.product,u.quantity+1,c.checkUrl,function(t){n.trigger("renderValue",[u]),t&&n.find(".js-buySpinner-inc").css({opacity:.5})}]):console.error("Товар не получен",u),a.blur()},u=function(e){e.stopPropagation();var a=t(e.target),n=t(a.data("widgetSelector")),r=t(a.data("buttonSelector")),o=t(a.data("valueSelector")),i=r.data("value"),c=o.data("value");console.info("incSpinnerValue",{$el:a,$target:r,$value:o,$widget:n});var u=i&&c?i.product[c.product.id]:null;u?r.trigger("changeProductQuantityData",[c.product,u.quantity-1,c.checkUrl,function(){n.trigger("renderValue",[u]),n.find(".js-buySpinner-inc").css({opacity:1})}]):console.error("Товар не получен",u),a.blur()},d=function(e){e.stopPropagation();var a=t(e.target),n=t(a.data("widgetSelector")),r=t(a.data("buttonSelector")),o=r.data("value"),i=a.data("value");console.info("changeSpinnerValue",{$el:a,$target:r,$widget:n});var c=a.val(),u=o&&i?o.product[i.product.id]:null;""!=c&&u&&r.trigger("changeProductQuantityData",[i.product,parseInt(c),i.checkUrl,function(){n.trigger("renderValue",[u]),n.find(".js-buySpinner-inc").css({opacity:1})}])},l=function(e,a){e.stopPropagation();var n=t(e.target);console.info("renderSpinnerValue",n,a),n.find(".js-buySpinner-value").val(a.quantity)},s=function(e){e.stopPropagation();var n=t(e.target);n.is(":checked")?t.cookie(a.credit.cookieName,1,{expires:7}):t.removeCookie(a.credit.cookieName),e.preventDefault()},g=function(e){e.stopPropagation(),t.removeCookie(a.credit.cookieName),e.preventDefault()},p=function(e){1==t.cookie(a.credit.cookieName)?e.attr("checked",!0):e.removeAttr("checked")};return n.on("click",".js-buyButton",r).on("changeProductQuantityData",".js-buyButton",i).on("changeProductQuantityData",".js-quickBuyButton",i).on("click",".js-deleteButton",o),n.on("click dblclick contextmenu",".js-buySpinner-inc",c).on("click dblclick contextmenu",".js-buySpinner-dec",u).on("change keyup",".js-buySpinner-value",d).on("renderValue",".js-buySpinner",l).on("changeProductQuantityData",".js-buySpinner-value",i),n.on("change",".js-creditButton",s).on("change",".js-creditButton-remove",g),p(t(".js-creditButton")),{initCredit:function(){p(t(".js-creditButton"))}}});