define(["require","jquery","underscore","mustache","module/util","module/config","module/form-validator","module/order/analytics.google","jquery.ui","jquery.maskedinput","module/toggleLink"],function(e,t,o,n,r,a,i,l){var d={cache:{},get:function(e,o){var n=e+"-"+o,r=d.cache[n]?d.cache[n]:t.parseJSON(t(e).html());return d.cache[n]||(d.cache[n]=r),r},set:function(e,t,o){var n=e+"-"+t;d.cache[n]=o},clear:function(){d.cache={}}},c=null,s=null,p=null,u=t("body"),f=t(".js-order-content"),g="m-body-loader",m=t(".js-order-delivery-form"),h=m.data("value"),v=t("#pointYandexMap"),y=t("#addressYandexMap"),k=t("#yandexMap-container"),b=t("#tpl-order-delivery-marker-balloon"),j=t("#tpl-order-delivery-point-popup"),S=t("#tpl-order-delivery-calendar"),_=t("#tpl-order-delivery-address-popup"),C=t("#tpl-order-delivery-point-suggest"),x=t("#tpl-order-delivery-discount-popup"),P=t("#tpl-modalWindow"),w=function(){return null===p?(p=t.Deferred(),e(["yandexmaps"],function(e){e.ready(function(){p.ymaps=e,p.resolve(p.ymaps)})})):"resolved"===p.state()&&p.resolve(p.ymaps),p},O=function(e,t){try{s=new ymaps.Map(e.attr("id"),{center:[t.center.lat,t.center.lng],zoom:t.zoom,controls:["zoomControl"]},{autoFitToViewport:"always"}),s.geoObjects.events.remove("click"),s.geoObjects.events.add("click",function(e){var t=e.get("target");s.balloon.open(e.get("coords"),n.render(b.html(),t.properties.get("point")))})}catch(o){console.error(o)}},T=function(e,t){try{c=new ymaps.Map(e.attr("id"),{center:[t.center.lat,t.center.lng],zoom:t.zoom,controls:["zoomControl"]},{autoFitToViewport:"always"})}catch(o){console.error(o)}},z=function(o){var n=o.find(".js-smartAddress-form"),r=t(n.data("kladrIdSelector")),i=t(n.data("mapContainerSelector"));e(["jquery.kladr"],function(){t.kladr.setDefault({token:a.kladr.token,key:a.kladr.key,type:t.kladr.type.street,parentType:t.kladr.type.city,parentId:a.kladr.city.id,parentInput:".js-smartAddress-form",select:function(){},check:function(){},checkBefore:function(){var e=t(this);return t.trim(e.val())?void 0:!1},change:function(e){var o,l=10,d=t.kladr.getAddress(".js-smartAddress-form",function(e){var o=a.kladr.city.name+"";return console.info("objs",e),r.length&&("object"===t.type(e.building)?r.val(e.building.id):"object"===t.type(e.street)&&r.val(e.street.id)),"object"===t.type(e.street)?t.each(e,function(e,n){var r="",a="";if("object"===t.type(n))switch(r=n.name,a=" "+n.type,n.contentType){case t.kladr.type.city:l=10;break;case t.kladr.type.street:l=13;break;case t.kladr.type.building:l=16}else r=n;o&&(o+=", "),o+=a+""+r}):o="",o});if(V(i,d,l),e&&"street"===e.contentType){n.find('[data-field="streetType"]').val(e.typeShort);try{o=e.type.length>8?e.typeShort:e.type,"string"==typeof o&&(o=o.charAt(0).toUpperCase()+o.substr(1).toLowerCase(),t(this).parent().find("label").text(o))}catch(c){console.error()}}}}),n.find(".js-smartAddress-input").each(function(e,o){var n=t(o);n.kladr("type",n.data("kladrType"))})})},D=function(e){f.addClass(g),t.ajax({url:m.attr("action"),data:e,type:"post",timeout:4e4}).done(function(e){t(m.data("containerSelector")).html(e)}).always(function(){console.info("unblock screen"),f.removeClass(g)}).error(function(e){var o,n;e&&302===e.status&&(o=t.parseJSON(e.responseText)||{},n=o.redirect||"/cart",window.location.href=n)}),d.clear(),u.trigger("beforeSplit")},A=function(e,o){var n,r,a,i=t(this),l=parseInt(i.data("index")),c=t(i.data("filterFormSelector"));o=!1!==o,e.stopPropagation(),!1!==o&&(l=0==l?1:0),console.info("index",l),n=i.find('[data-index="'+l+'"]'),r=t(n.data("containerSelector")),a=t(r.data("parentContainerSelector")),o&&a.toggleClass(a.data("toggleClass")),i.data("index",l),i.find("[data-index]").each(function(e,o){t(o).hide()}),L(i.data("storageSelector"),c),n.show(),r.trigger("update",[d.get(i.data("storageSelector"),"filtered")])},I=function(e,n){var r=t(this),a=r.data("mapOption"),i=function(){var e;console.info("update point map ..."),r.find("#"+v.attr("id")).length||(r.html(""),r.append(v)),s.setCenter([a.center.lat,a.center.lng],a.zoom),s.balloon.close(),s.geoObjects.removeAll(),s.container.fitToViewport(),o.each(n.points,function(t){try{e=new ymaps.Placemark([t.lat,t.lng],{point:t,hintContent:t.name},{iconLayout:"default#image",iconImageHref:"/img/points/markers/23x30/"+t.icon,iconImageSize:[23,30],iconImageOffset:[-12,-30],zIndex:"shops"==t.group.token?1e3:0}),s.geoObjects.add(e)}catch(o){console.error(o,t)}})};s?i():w().done(function(){O(v,a),i()})},q=function(e,o){var r=t(this),a=j.data("partial")["page/order/delivery/point-list"];console.info("update point list ...",o),r.html(n.render(a,o)),r.find(".content-scroll").scrollTop()},M=function(e){var o=t(this),n=t(o.data("formSelector")),r=t(n.data("tabSelector"));e.stopPropagation(),r.trigger("update",[!1])},L=function(e,n){var r,a,i,l=t(n.data("suggestInputSelector")).data("center")||null,c=d.get(e,"base"),s=J(n),p={};if(o.extend(p,c),p.points=c.points.filter(function(e){for(r in s)if(-1===o.indexOf(s[r],e[r].value))return console.info("pass",r,s[r],e[r].value),!1;return!0}),l){console.info(l);try{o.each(p.points,function(e){a=Math.abs(e.lat-l[0]),i=Math.abs(e.lng-l[1]),e.distance=Math.sqrt(a*a+i*i),e.distance>.2}),p.points.sort(function(e,t){return e.distance-t.distance})}catch(u){console.error(u)}}d.set(e,"filtered",p)},J=function(e){var o=e.find("input"),n={};return o.each(function(e){var o=t(this),r=o.data("value");e=r.name,1==o.prop("checked")&&("undefined"==typeof n[e]&&(n[e]=[]),n[e].push(r.value))}),n},N=function(e){var o=t(this),r=t(P.html()).appendTo(u),a=d.get(o.data("storageSelector"),"filtered"),i=o.data("modal-title"),l=o.data("modal-position"),c=function(){r.trigger("close")};e.stopPropagation(),r.find(".js-modal-title").text(i),r.addClass(l),r.lightbox_me({onLoad:function(){r.find(".js-modal-content").append(n.render(j.html(),a,j.data("partial")))},beforeClose:function(){k.append(v),u.off("beforeSplit",c)}}),u.on("beforeSplit",c),e.preventDefault()},B=function(e){var o=t(this),r=t(P.html()).appendTo(u),a=o.data("modal-title"),i=o.data("modal-position"),l=t.parseJSON(t(o.data("dataSelector")).html()),d=function(){r.trigger("close")};e.stopPropagation(),r.find(".js-modal-title").text(a),r.addClass(i),r.lightbox_me({onLoad:function(){var e,a;r.find(".js-modal-content").append(n.render(_.html(),l)),z(r),e=t(o.data("mapContainerSelector")),a=e.data("mapOption"),e.find("#"+y.attr("id")).length||(e.html(""),e.append(y)),c||w().done(function(){T(y,a)})},beforeClose:function(){k.append(y),u.off("beforeSplit",d)},modalCSS:{top:"60px"}}),u.on("beforeSplit",d)},V=function(e,t,o){w().done(function(e){var n=e.geocode(t);n.then(function(e){var t=e.geoObjects.get(0),n=t?t.geometry.getCoordinates():null;n&&c.setCenter(n,o)})})},$=function(e){var o=t(this),r=t.parseJSON(t(o.data("dataSelector")).html()),a=t(P.html()).appendTo(u),i=o.data("modal-title"),l=o.data("modal-position"),d=function(){setTimeout(function(){a.trigger("close")},400)};e.stopPropagation(),a.find(".js-modal-title").text(i),a.addClass(l),a.lightbox_me({fullScreen:!0,modal:!1,onLoad:function(){a.find(".js-modal-content").append(n.render(S.html(),r))},beforeClose:function(){u.off("beforeSplit",d)}}),u.on("beforeSplit",d)},F=function(e){var o,r=t(this),a=t.parseJSON(t(r.data("storageSelector")).html()),i=t(P.html()).appendTo(u),l=r.data("modal-title"),d=r.data("modal-position"),c=function(){i.trigger("close")};e.stopPropagation(),i.find(".js-modal-title").text(l),i.addClass(d),i.lightbox_me({onLoad:function(){i.find(".js-modal-content").append(n.render(x.html(),a)),o=t(".js-user-discount-container"),o.length&&o.data("url")&&t.get(o.data("url")).done(function(e){o.html(e.content);var n=i.find(".js-discount-form");n.length&&o.on("click",".js-user-discount",function(e){var o=t(this),r=o.data("value");$field=n.find('[data-field="number"]'),e.preventDefault(),e.stopPropagation(),$field.val(r),$field.closest("form").submit()})})},beforeClose:function(){u.off("beforeSplit",c)},centered:!1}),u.on("beforeSplit",c),e.preventDefault()},U=function(e){var o=t(this),r=o.val(),i=o.data("suggestContainerSelector"),l=t(i),d={items:[]},c={};e.stopPropagation(),o.data("center",null),w().done(function(e){if(r.length>1){try{r=a.kladr.city.name+", "+r}catch(t){console.error(t)}s&&(c={boundedBy:s.geoObjects.getBounds(),strictBounds:!0}),e.geocode(r,c).then(function(e){e.geoObjects.each(function(e){d.items.push({name:e.properties.get("name"),dataCenterValue:JSON.stringify(e.geometry.getBounds()[0]).replace(/\"/g,"&quot;"),containerSelector:i})}),l.html(n.render(C.html(),d)),l.show()},function(e){console.warn("Geocode error",e)})}})},Y=function(e){var o=t(this),n=o.data("center"),r=t(o.data("containerSelector")),a=t(r.data("inputSelector"));e.stopPropagation(),e.preventDefault(),console.info("center",n);try{n&&(a.length&&(a.val(o.text()),a.data("center",n)),s&&v.is(":visible")?s.setCenter(n,14):t(".js-order-delivery-point-tab-link").trigger("update",[!1]))}catch(i){console.error(i)}r.hide()},G=function(e){var o,n=t(this),r=t(n.data("suggestInputSelector"));e.stopPropagation(),e.preventDefault(),console.info("$input",r),navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(e){o=[e.coords.latitude,e.coords.longitude],console.info(o);try{r.length&&(r.val(""),r.data("center",o)),s&&v.is(":visible")?s.setCenter(o,13):t(".js-order-delivery-point-tab-link").trigger("update",[!1])}catch(n){console.error(n)}})};u.on("click",".js-order-delivery-form-control",function(e){var o=t(this),n=o.data("value");console.info("changeSplit",o,o.is(":checkbox")),e.stopPropagation(),o.is(":checkbox")||o.is(":radio")||e.preventDefault(),n&&D(n)}),u.on("click",".js-order-delivery-pointPopup-link",N),u.on("click",".js-order-delivery-addressPopup-link",B),u.on("click",".js-order-delivery-discountPopup-link",F),u.on("click",".js-order-delivery-point-tab-link",A),u.on("update",".js-order-delivery-point-tab-link",A),u.on("click",".js-order-delivery-celendar-link",$),u.on("update",".js-order-delivery-map-container",I),u.on("update",".js-order-delivery-point-container",q),u.on("change",".js-order-delivery-point-filter",M),u.on("input",".js-order-delivery-point-search-input",U),u.on("click",".js-order-delivery-suggest-item",Y),u.on("click",".js-order-delivery-geolocation-link",G),u.on("submit",".js-smartAddress-form",function(e){var o=t(this),n=o.serializeArray();e.stopPropagation(),e.preventDefault(),i.validateRequired(o).isValid&&D(n),setTimeout(function(){l.push(["10_1 Доставки_Доставка_ОБЯЗАТЕЛЬНО"])},250)}),u.on("submit",".js-discount-form",function(e){var o=t(this),n=o.serializeArray(),r=o.data("checkUrl");r?(f.addClass(g),t.ajax({url:r,data:{code:o.find('[data-field="number"]').val()},type:"post",timeout:15e3}).done(function(e){!0===e.success?D(n):!0===e.showPin?(o.find('[data-field-container="pin"]').show(),o.find('[data-field="pin"]').focus()):D(n)}).always(function(){f.removeClass(g),console.info("unblock screen")}).error(function(){D(n)})):D(n),e.stopPropagation(),e.preventDefault()}),u.on("submit",".js-order-form",function(e){var o=t(this),n=o.find('[data-field="accept"]');e.stopPropagation(),n.length&&(n.is(":checked")?(n.parent().removeClass("error"),l.push(["15_1 Оформить_успешно_Доставка_ОБЯЗАТЕЛЬНО"])):(n.parent().addClass("error"),e.preventDefault(),l.push(["15_2 Оформить_ошибка_Доставка","Поле ошибки: accept"])))});try{navigator.geolocation||t(".js-order-delivery-geolocation-link").hide()}catch(H){console.error(H)}i.init(),console.info("config",a);try{l.push(["7 Вход_Доставка_ОБЯЗАТЕЛЬНО","Количество заказов: "+h.order.count]),u.on("submit",".js-regionSet-form",function(){var e=t(this);l.push(["8 Регион_Доставка","Было: "+a.region.name+", Стало: "+e.find("#js-regionSet-input").val()])}),u.on("click",".js-regionSet-link",function(){var e=t(this);l.push(["8 Регион_Доставка","Было: "+a.region.name+", Стало: "+e.text()])}),u.on("click",".js-order-delivery-pointPopup-link",function(){l.push(["10 Место_самовывоза_Доставка_ОБЯЗАТЕЛЬНО"])}),u.on("click",".js-order-delivery-celendar-link",function(){l.push(["11 Срок_доставки_Доставка"])}),u.on("click",".js-order-delivery-discountPopup-link",function(){l.push(["12 Код_скидки_Доставка"])}),u.on("click",".js-order-form-accept-field",function(){l.push(["14 Согласен_оферта_Доставка_ОБЯЗАТЕЛЬНО"])}),u.on("click",".js-order-delivery-form-control",function(){var e=t(this);"date"===e.data("type")?l.push(["11_1 Срок_Изменил_дату_Доставка"]):"payment"===e.data("type")&&"2"===e.val()?l.push(["13_1 Оплата_банковской_картой_Доставка"]):"point"===e.data("type")&&l.push(["10_1 Ввод_данных_Самовывоза"])})}catch(H){console.error(H)}});