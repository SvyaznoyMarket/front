define(["jquery","underscore","mustache"],function(e,t,a){require(["jquery.deparam"],function(){function r(t,a){if("undefined"!=typeof history.pushState){var r=e.deparam((location.search||"").slice(1))||{};null===a?delete r[t]:r[t]=a,history.pushState({},"","?"+e.param(r))}}var o=e("body"),n=e(".js-productList-container"),i={},c=function(t,a){if(t.stopPropagation(),!a||!a.disableFiltering){var o=e(t.target),c=n.data("value"),l=o.attr("name");console.info("setFilter",o),o.is(":radio")?o.is(":checked")&&i[l]!==o[0]?(c[l]=o.val(),r(l,o.val()),i[l]=o[0]):(delete c[l],r(l,null),o.removeAttr("checked"),i[l]=null):o.is(":checkbox")?o.is(":checked")?(c[l]=o.val(),r(l,o.val())):(delete c[l],r(l,null)):o.is(":text")&&(c[l]=o.val(),r(l,o.val())),c.page=1,p({clear:!0})}},l=function(a){a.stopPropagation();var o=e(a.target),c=o.data("name"),l=n.data("value");if(console.info("deleteFilter",a,l,c),c){t.each(l,function(e,t){return t==c?(delete l[c],r(c,null),!0):void 0});var s=e(".js-productFilter-set").filter('[name="'+c+'"]');s.length&&(s.is(":radio")?(s.removeAttr("checked"),i[s.attr("name")]=null):s.is(":checkbox")?s.removeAttr("checked"):s.is(":text")&&(s.val(s.data("value")),s.trigger("change",{disableFiltering:!0}))),l.page=1,p({clear:!0}),a.preventDefault()}},s=function(a){a.stopPropagation();var r=n.data("value"),o=n.data("reset");console.info("clearFilter",a,r),o.sort=r.sort,n.data("value",t.extend({},o)),e(".js-productFilter-set").each(function(t,a){var r=e(a);r.is(":radio, :checkbox")?r.removeAttr("checked"):r.is(":text")&&(r.val(r.data("value")),r.trigger("change",{disableFiltering:!0}))}),t.each(i,function(e,t){i[t]=null}),"undefined"!=typeof history.pushState&&(o.sort?history.pushState({},"","?"+e.param({sort:o.sort})):history.pushState({},"","?")),r.page=1,p({clear:!0}),a.preventDefault()},d=function(a){a.stopPropagation();var o=e(a.target),i=o.data("value"),c=n.data("value");console.info("setSorting",o),t.isObject(i)&&(t.each(i,function(e,t){c[t]=e,r(t,e)}),c.page=1,p({clear:!0}),a.preventDefault())},u=function(e){e.stopPropagation(),console.info("loadMoreProducts",e),p({clear:!1}),e.preventDefault()},p=function(r){var i=e(".js-productList-more"),c=n.data("url"),l=n.data("value");r=t.extend({clear:!1},r),console.info("loadProduct",i,n,l),c&&!0!==i.data("disabled")&&(e.get(c,l).done(function(c){t.isObject(c.result)&&l&&n.length&&(!0===r.clear&&n.empty(),l.page=c.result.page,l.count=c.result.count,l.count<=l.page*l.limit?i.hide():i.show(),0==l.count?e(".js-noProducts").length||n.after(a.render(e("#tpl-productList-noProducts").html())):e(".js-noProducts").remove(),t.each(c.result.productCards,function(e){n.append(e)}),t.isObject(c.result.widgets)&&(o.data("widget",c.result.widgets),o.trigger("render")))}).always(function(){i.data("disabled",!1)}),i.data("disabled",!0))};o.on("click dblclick",".js-productList-more",u).on("click",'input[type="radio"].js-productFilter-set',c).on("change",'input[type="checkbox"].js-productFilter-set',c).on("change",'input[type="text"].js-productFilter-set',c).on("click",".js-productFilter-delete",l).on("click",".js-productFilter-clear",s).on("click",".js-productFilter-sort",d)})});