define(["jquery","underscore","mustache","module/util"],function(e,t,a,r){require(["jquery.deparam"],function(){function o(t,a){if("undefined"!=typeof history.pushState){var r=e.deparam((location.search||"").slice(1))||{};null===a?delete r[t]:r[t]=a,history.pushState({},"","?"+e.param(r))}}var i=e("body"),n=e(".js-productList-container"),l={},c=function(t,a){if(t.stopPropagation(),!a||!a.disableFiltering){var r=e(t.target),i=n.data("value"),c=r.attr("name");console.info("setFilter",r),r.is(":radio")?r.is(":checked")&&l[c]!==r[0]?(i[c]=r.val(),o(c,r.val()),l[c]=r[0]):(delete i[c],o(c,null),r.removeAttr("checked"),l[c]=null):r.is(":checkbox")?r.is(":checked")?(i[c]=r.val(),o(c,r.val())):(delete i[c],o(c,null)):r.is(":text")&&(i[c]=r.val(),o(c,r.val())),i.page=1,h({clear:!0})}},s=function(a){a.stopPropagation();var r=e(a.target),i=r.data("name"),c=n.data("value");if(console.info("deleteFilter",a,c,i),i){t.each(c,function(e,t){if(t==i)return delete c[i],o(i,null),!0});var s=e(".js-productFilter-set").filter('[name="'+i+'"]');s.length&&(s.is(":radio")?(s.removeAttr("checked"),l[s.attr("name")]=null):s.is(":checkbox")?s.removeAttr("checked"):s.is(":text")&&(s.val(s.data("value")),s.trigger("change",{disableFiltering:!0}))),c.page=1,h({clear:!0}),a.preventDefault()}},d=function(a){a.stopPropagation();var r=n.data("value"),o=n.data("reset");console.info("clearFilter",a,r),o.sort=r.sort,n.data("value",t.extend({},o)),e(".js-productFilter-set").each(function(t,a){var r=e(a);r.is(":radio, :checkbox")?r.removeAttr("checked"):r.is(":text")&&(r.val(r.data("value")),r.trigger("change",{disableFiltering:!0}))}),t.each(l,function(e,t){l[t]=null}),"undefined"!=typeof history.pushState&&(o.sort?history.pushState({},"","?"+e.param({sort:o.sort})):history.pushState({},"","?")),r.page=1,h({clear:!0}),a.preventDefault()},u=function(a){a.stopPropagation();var r=e(a.target),i=r.data("value"),l=n.data("value");console.info("setSorting",r),t.isObject(i)&&(t.each(i,function(e,t){l[t]=e,o(t,e)}),l.page=1,h({clear:!0}),a.preventDefault())},p=function(e){e.stopPropagation(),console.info("loadMoreProducts",e),h({clear:!1}),e.preventDefault()},h=function(o){var l=e(".js-productList-more"),c=n.data("url"),s=n.data("value");o=t.extend({clear:!1},o),console.info("loadProduct",l,n,s),c&&!0!==l.data("disabled")&&(e.get(c,s).done(function(c){t.isObject(c.result)&&s&&n.length&&(!0===o.clear&&n.empty(),s.page=c.result.page,s.count=c.result.count,s.count<=s.page*s.limit?l.hide():l.show(),0==s.count?e(".js-noProducts").length||n.after(a.render(e("#tpl-productList-noProducts").html())):e(".js-noProducts").remove(),t.each(c.result.productCards,function(e){n.append(e)}),t.isObject(c.result.widgets)&&(i.data("widget",c.result.widgets),i.trigger("render")),c.result.gdeSlonLandingUrls&&e.each(c.result.gdeSlonLandingUrls,function(e,t){r.loadScript(t,!0)}))}).always(function(){l.data("disabled",!1)}),l.data("disabled",!0))};i.on("click dblclick",".js-productList-more",p).on("click",'input[type="radio"].js-productFilter-set',c).on("change",'input[type="checkbox"].js-productFilter-set',c).on("change",'input[type="text"].js-productFilter-set',c).on("click",".js-productFilter-delete",s).on("click",".js-productFilter-clear",d).on("click",".js-productFilter-sort",u),e(window).width()<490&&e(".catalogList_item_new").each(function(){var t=e(this).height();e(this).find(".catalogListItemWrapper").css("height",t)})})});