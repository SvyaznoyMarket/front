define(["jquery","module/config"],function(t,n){var a={formatCurrency:function(t){return t=String(t),t=t.replace(",","."),t=t.replace(/\s/g,""),t=String(Number(t).toFixed(2)),t=t.split("."),t[0].length>=5&&(t[0]=t[0].replace(/(\d)(?=(\d\d\d)+([^\d]|$))/g,"$1 ")),0==t[1]&&(t=t.slice(0,1)),t.join(".")},loadScript:function(t,n){var a=document.createElement("script");a.src=t,a.async=!!n,a.type="text/javascript",document.getElementsByTagName("head")[0].appendChild(a)},trackGoogleAnalyticsTransaction:function(n){function a(n){if(n=t.extend(!0,{},n),!n.transaction.id)throw"Некорректный ID транзакции";if(!n.transaction.total)throw"Некорректная сумма заказа";return n.transaction.id=n.transaction.id?n.transaction.id+"":"",n.transaction.affiliation=n.transaction.affiliation?n.transaction.affiliation+"":"",n.transaction.total=n.transaction.total?n.transaction.total+"":"",n.transaction.tax=n.transaction.tax?n.transaction.tax+"":"0",n.transaction.shipping=n.transaction.shipping?n.transaction.shipping+"":"0",n.transaction.city=n.transaction.city?n.transaction.city+"":"",n.products=t.map(n.products,function(t){if(!t.name)throw"Некорректное название товара";if(!t.price)throw"Некорректная цена товара";if(!t.quantity)throw"Некорректное количество товара";return{sku:t.sku?t.sku+"":"",name:t.name?t.name+"":"",category:t.category?t.category+"":"",price:t.price?t.price+"":"",quantity:t.quantity?t.quantity+"":""}}),n}function e(n){"function"==typeof ga&&0!=ga.getAll().length?(ga("require","ecommerce","ecommerce.js"),ga("ecommerce:addTransaction",{id:n.transaction.id,affiliation:n.transaction.affiliation,revenue:n.transaction.total,shipping:n.transaction.shipping,tax:n.transaction.tax}),t.each(n.products,function(t,a){ga("ecommerce:addItem",{id:n.transaction.id,name:a.name,sku:a.sku,category:a.category,price:a.price,quantity:a.quantity})}),ga("ecommerce:send")):console.warn("No Universal Google Analytics function found")}try{n=a(n),e(n)}catch(t){console.error("[Google Analytics Ecommerce] %s",t)}},trackGoogleAnalyticsEvent:function(t){"send"==t[0]&&"event"==t[1]&&(console.log("ga event",t),"undefined"!=typeof t[2]&&(t[2]=String(t[2])),"undefined"!=typeof t[3]&&(t[3]=String(t[3])),"undefined"!=typeof t[4]&&(t[4]=String(t[4])),"undefined"!=typeof t[5]&&(t[5]=Number(t[5])),"undefined"!=typeof ga&&ga.apply(ga,t))},sendOrdersToGoogleAnalytics:function(n){n&&t.each(n,function(n,e){a.trackGoogleAnalyticsTransaction({transaction:{id:e.numberErp,affiliation:e.isPartner?"Партнер":"Enter",total:e.paySum,shipping:e.delivery.price,city:e.region.name},products:t.map(e.products,function(t){return{id:t.id,name:t.name,sku:t.article,category:t.categories.length?t.categories[0].name+" - "+t.categories[t.categories.length-1].name:"",price:t.price,quantity:t.quantity}})})})},partner:{flocktory:{send:function(a){function e(t){window.flocktory=window.flocktory||[],window.flocktory.push(t)}if(n.partner.service.flocktory)switch(a.action){case"postcheckout":var i=0;t.each(a.orders,function(n,o){i++,e(["postcheckout",{user:{name:t.trim(o.firstName+" "+o.lastName),email:o.email?o.email:o.phone+"@unknown.email",sex:1==o.user.sex?"m":2==o.user.sex?"f":""},order:{id:o.numberErp,price:o.paySum,items:t.map(o.products,function(t){return{id:t.id,title:t.name,price:t.price,image:t.images["120x120"].url,count:t.quantity}})},spot:i>1?"no_popup":a.spot||""}])});break;default:e([a.action,{item:a.item}])}}}}};return a});