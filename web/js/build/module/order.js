define(["require","jquery","underscore","mustache","module/util","jquery.maskedinput","module/order/user.form","module/order/common","module/order/toggle","jquery.modal"],function(e,o,r,t){var n=o("body"),a=o(".js-order-delivery-form"),l=o("#yandexMap"),i=(o("#yandexMap-container"),o("#tpl-order-delivery-marker-balloon")),d=o("#tpl-order-delivery-point-popup"),c=(o("#tpl-order-delivery-calendar"),o("#tpl-order-delivery-address-popup"),function(e){e.geoObjects.events.remove("click"),e.geoObjects.events.add("click",function(o){var r=o.get("target");console.info("placemark",r,r.properties.get("point")),e.balloon.open(o.get("coords"),t.render(i.html(),r.properties.get("point")))})}),p=function(e){e.stopPropagation();var r=o(this);o.ajax({url:a.attr("action"),data:r.data("value"),type:"post",timeout:3e4}).done(function(e){o(a.data("containerSelector")).html(e)}).always(function(){console.info("unblock screen")}),e.preventDefault()},s=function(r){r.stopPropagation();var n=o(this),a=o("#tpl-order-delivery-point-popup"),l=o.parseJSON(o(n.data("dataSelector")).html());o(".js-modal-open").lightbox_me({onLoad:function(){var e=o(".js-modal-content");e.append(t.render(a.html(),l))},showOverlay:!1}),r.preventDefault(),e(["yandexmaps"],function(){})},m=function(){var e={};t.render(d.html(),e)},u=function(e){e.stopPropagation();var r=o(this),n=o("#tpl-order-delivery-calendar"),a=o.parseJSON(o(r.data("dataSelector")).html());o(".js-modal-open").lightbox_me({onLoad:function(){var e=o(".js-modal-content");e.append(t.render(n.html(),a))}})},v=function(t){t.stopPropagation();var n=o(t.currentTarget),a=o(n.data("containerSelector")),i=n.data("mapData");e(["module/yandexmaps"],function(e){e.initMap(l,i,c).done(function(t){var d,c=o.parseJSON(o(n.data("dataSelector")).html()).points;t.setCenter([i.center.lat,i.center.lng],i.zoom),t.balloon.close(),t.geoObjects.removeAll(),t.container.fitToViewport(),r.each(c,function(o){try{d=new e.ymaps.Placemark([o.lat,o.lng],{point:o,hintContent:o.name},{iconLayout:"default#image",iconImageHref:"/img/markers/"+o.icon,iconImageSize:[28,39],iconImageOffset:[-14,-39],zIndex:"shops"==o.group.token?1e3:0}),t.geoObjects.add(d)}catch(r){console.error(r)}}),a.append(l)})})};n.on("click",".js-order-delivery-form-control",p),n.on("click",".js-order-delivery-pointPopup-link",s),n.on("click",".js-order-delivery-addressPopup-link",m),n.on("click",".js-order-delivery-map-link",v),n.on("click",".js-order-delivery-celendar-link",u)});