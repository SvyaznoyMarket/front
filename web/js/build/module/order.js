define(["require","jquery","underscore","mustache","module/util","module/config","jquery.ui","jquery.validate","jquery.maskedinput","module/order/user.form","module/order/common","module/order/toggle"],function(e,t,o,n,r,a){function l(e){return console.log("success form"),console.log(e),e.errors.length&&$field.each(function(o){for(i=0;i<e.errors.length;i++)o=e.errors[i].field,message=e.errors[i].name,t(this).data("field-name")!=o||t(this).hasClass(errClass)||(tmpl='<div class="error-text js-field-error">'+message+"</div>",t(this).addClass(errClass).closest(".js-user-wrap").prepend(tmpl))}),null!=e.redirect&&e.redirect.length&&(window.location.href=e.redirect),!1}var d={cache:{},get:function(e,o){var n=e+"-"+o,r=d.cache[n]?d.cache[n]:t.parseJSON(t(e).html());return d.cache[n]||(d.cache[n]=r),r},set:function(e,t,o){var n=e+"-"+t;d.cache[n]=o},clear:function(){d.cache={}}},s=null,c=null,u=null,p=t("body"),f=t(".js-order-delivery-form"),m=t("#pointYandexMap"),g=t("#addressYandexMap"),h=t("#yandexMap-container"),v=t("#tpl-order-delivery-marker-balloon"),y=t("#tpl-order-delivery-point-popup"),x=t("#tpl-order-delivery-calendar"),j=t("#tpl-order-delivery-address-popup"),b=t("#tpl-order-delivery-point-suggest"),k=t("#tpl-order-delivery-discount-popup"),S=t("#tpl-modalWindow"),C=t("[data-scroll]"),w=(t(".js-validate"),function(o,r){var a=t.Deferred();return c&&a.resolve(o),e(["yandexmaps"],function(e){e.ready(function(){try{c=new e.Map(o.attr("id"),{center:[r.center.lat,r.center.lng],zoom:r.zoom,controls:[]},{autoFitToViewport:"always"}),c.geoObjects.events.remove("click"),c.geoObjects.events.add("click",function(e){var t=e.get("target");c.balloon.open(e.get("coords"),n.render(v.html(),t.properties.get("point")))}),a.resolve(o)}catch(t){console.error(t),a.reject(t)}})}),a}),O=function(o,n){var r=t.Deferred();return s&&r.resolve(o),e(["yandexmaps"],function(e){e.ready(function(){try{s=new e.Map(o.attr("id"),{center:[n.center.lat,n.center.lng],zoom:n.zoom},{autoFitToViewport:"always"}),r.resolve(o)}catch(t){console.error(t),r.reject(t)}})}),r},P=function(){var o=t.Deferred();return null!==u&&o.resolve(u),e(["yandexmaps"],function(e){e.ready(function(){u=e,o.resolve(u)})}),o},T=function(o){var n=o.find(".js-smartAddress-form"),r=t(n.data("kladrIdSelector")),i=t(n.data("mapContainerSelector"));e(["jquery.kladr"],function(){t.kladr.setDefault({token:a.kladr.token,key:a.kladr.key,type:t.kladr.type.street,parentType:t.kladr.type.city,parentId:a.kladr.city.id,parentInput:".js-smartAddress-form",select:function(){},check:function(){},checkBefore:function(){var e=t(this);return t.trim(e.val())?void 0:!1},change:function(e){var o,l=10,d=t.kladr.getAddress(".js-smartAddress-form",function(e){var o=a.kladr.city.name+"";return r.length&&("object"===t.type(e.building)?r.val(e.building.id):"object"===t.type(e.street)&&r.val(e.street.id)),"object"===t.type(e.street)?t.each(e,function(e,n){var r="",a="";if("object"===t.type(n))switch(r=n.name,a=" "+n.type,n.contentType){case t.kladr.type.city:l=10;break;case t.kladr.type.street:l=13;break;case t.kladr.type.building:l=16}else r=n;o&&(o+=", "),o+=a+""+r}):o="",o});B(i,d,l),e&&(o=e.type.length>8?e.typeShort:e.type,o=o.charAt(0).toUpperCase()+o.substr(1).toLowerCase(),"street"===e.contentType&&n.find('[data-field="streetType"]').val(e.typeShort),t(this).parent().find("label").text(o))}}),n.find(".js-smartAddress-input").each(function(e,o){var n=t(o);n.kladr("type",n.data("kladrType"))})})},D=function(e){t.ajax({url:f.attr("action"),data:e,type:"post",timeout:4e4}).done(function(e){t(f.data("containerSelector")).html(e)}).always(function(){console.info("unblock screen")}).error(function(e){var o,n;e&&302===e.status&&(o=t.parseJSON(e.responseText)||{},n=o.redirect||"/cart",window.location.href=n)}),d.clear(),p.trigger("beforeSplit")},A=function(e,o){var n,r,a,i=t(this),l=parseInt(i.data("index")),s=t(i.data("filterFormSelector"));e.stopPropagation(),!1!==o&&(l=0==l?1:0),n=i.find('[data-index="'+l+'"]'),r=t(n.data("containerSelector")),a=t(r.data("parentContainerSelector")),i.data("index",l),i.find("[data-index]").each(function(e,o){t(o).hide()}),M(i.data("storageSelector"),s),n.show(),a.toggleClass(a.data("toggleClass")),r.trigger("update",[d.get(i.data("storageSelector"),"filtered")])},q=function(e,n){var r=t(this),a=r.data("mapOption"),i=function(){var e;console.info("update point map ..."),r.find("#"+m.attr("id")).length||r.append(m),c.setCenter([a.center.lat,a.center.lng],a.zoom),c.balloon.close(),c.geoObjects.removeAll(),c.container.fitToViewport(),o.each(n.points,function(t){try{e=new ymaps.Placemark([t.lat,t.lng],{point:t,hintContent:t.name},{iconLayout:"default#image",iconImageHref:"/img/markers/"+t.icon,iconImageSize:[28,39],iconImageOffset:[-14,-39],zIndex:"shops"==t.group.token?1e3:0}),c.geoObjects.add(e)}catch(o){console.error(o,t)}})};c?i():w(m,a).done(i)},I=function(e,o){var r=t(this),a=y.data("partial")["page/order/delivery/point-list"];console.info("update point list ..."),r.html(n.render(a,o)),r.find(".content-scroll").scrollTop()},z=function(){var e=t(this),o=t(e.data("formSelector")),n=t(o.data("tabSelector"));n.trigger("update",[!1])},M=function(e,n){var r,a,i,l,s=t(n.data("suggestInputSelector")).data("center")||null,c=d.get(e,"base"),u=N(n),p={};if(o.extend(p,c),p.points=c.points.filter(function(e){for(r in e)if(u[r]&&u[r].length&&e[r]&&e[r].hasOwnProperty("value")&&(a=u[r].indexOf(e[r].value.toString()),-1===a))return!1;return!0}),s)try{o.each(p.points,function(e){i=Math.abs(e.lat-s[0]),l=Math.abs(e.lng-s[1]),e.distance=Math.sqrt(i*i+l*l),e.distance>.2}),p.points.sort(function(e,t){return e.distance-t.distance})}catch(f){console.error(f)}d.set(e,"filtered",p)},N=function(e){var o=e.find("input"),n={};return o.each(function(e){var o=t(this),r=o.data("value");e=r.name,"undefined"==typeof n[e]&&(n[e]=[]),1==o.prop("checked")&&n[e].push(r.value.toString())}),n},J=function(o){var r=t(this),a=t(S.html()).appendTo(p),i=d.get(r.data("storageSelector"),"filtered"),l=r.data("modal-title"),s=r.data("modal-position"),c=function(){a.trigger("close")};o.stopPropagation(),a.find(".js-modal-title").text(l),a.addClass(s),a.lightbox_me({onLoad:function(){a.find(".js-modal-content").append(n.render(y.html(),i,y.data("partial")))},beforeClose:function(){h.append(m),p.off("beforeSplit",c)}}),p.on("beforeSplit",c),o.preventDefault(),setTimeout(function(){e(["yandexmaps"],function(){})},1e3)},L=function(o){var r=t(this),a=t(S.html()).appendTo(p),i=r.data("modal-title"),l=r.data("modal-position"),d=t.parseJSON(t(r.data("dataSelector")).html()),s=function(){a.trigger("close")};o.stopPropagation(),e(["jquery.kladr"],function(){}),e(["yandexmaps"],function(){}),a.find(".js-modal-title").text(i),a.addClass(l),a.lightbox_me({onLoad:function(){a.find(".js-modal-content").append(n.render(j.html(),d)),T(a),U(".js-validate"),e(["yandexmaps"],function(){var e=t(r.data("mapContainerSelector"));B(e)})},beforeClose:function(){h.append(g),p.off("beforeSplit",s)},modalCSS:{top:"60px"}}),p.on("beforeSplit",s)},B=function(t,o,n){var r=t.data("mapOption"),a=function(){console.info("update address map ..."),t.find("#"+g.attr("id")).length||t.append(g),s.balloon.close(),s.geoObjects.removeAll(),s.container.fitToViewport()};s?a():O(g,r).done(a),o&&e(["yandexmaps"],function(e){if(s){var t=e.geocode(o);t.then(function(t){s.balloon.close(),s.geoObjects.removeAll();var o=t.geoObjects.get(0).geometry.getCoordinates(),r=new e.Placemark(o,{},{});s.geoObjects.add(r),s.setCenter(o,n)})}})},V=function(e){var o=t(this),r=t.parseJSON(t(o.data("dataSelector")).html()),a=t(S.html()).appendTo(p),i=o.data("modal-title"),l=o.data("modal-position"),d=function(){setTimeout(function(){a.trigger("close")},400)};e.stopPropagation(),a.find(".js-modal-title").text(i),a.addClass(l),a.lightbox_me({fullScreen:!0,modal:!1,onLoad:function(){a.find(".js-modal-content").append(n.render(x.html(),r))},beforeClose:function(){p.off("beforeSplit",d)}}),p.on("beforeSplit",d)},$=function(e){var o,r=t(this),a=t.parseJSON(t(r.data("storageSelector")).html()),i=t(S.html()).appendTo(p),l=r.data("modal-title"),d=r.data("modal-position"),s=function(){i.trigger("close")};e.stopPropagation(),i.find(".js-modal-title").text(l),i.addClass(d),i.lightbox_me({onLoad:function(){i.find(".js-modal-content").append(n.render(k.html(),a)),o=t(".js-user-discount-container"),o.length&&o.data("url")&&t.get(o.data("url")).done(function(e){o.html(e.content);var n=i.find(".js-discount-form");n.length&&o.on("click",".js-user-discount",function(e){var o=t(this),r=o.data("value");$field=n.find('[data-field="number"]'),e.preventDefault(),e.stopPropagation(),$field.val(r)})})},beforeClose:function(){p.off("beforeSplit",s)},centered:!1}),p.on("beforeSplit",s),e.preventDefault()},_=function(e){var o=t(this),r=o.val(),i=o.data("suggestContainerSelector"),l=t(i),d={items:[]},s={};e.stopPropagation(),o.data("center",null),P().done(function(e){if(r.length>1){try{r=a.kladr.city.name+", "+r}catch(t){console.error(t)}c&&(s={boundedBy:c.geoObjects.getBounds(),strictBounds:!0}),e.geocode(r,s).then(function(e){e.geoObjects.each(function(e){d.items.push({name:e.properties.get("name"),dataCenterValue:JSON.stringify(e.geometry.getBounds()[0]).replace(/\"/g,"&quot;"),containerSelector:i})}),l.html(n.render(b.html(),d)),l.show()},function(e){console.warn("Geocode error",e)})}})},F=function(e){var o=t(this),n=o.data("center"),r=t(o.data("containerSelector")),a=t(r.data("inputSelector"));e.stopPropagation(),e.preventDefault(),console.info("center",n);try{n&&(a.length&&(a.val(o.text()),a.data("center",n)),c&&m.is(":visible")?c.setCenter(n,14):t(".js-order-delivery-point-tab-link").trigger("update",[!1]))}catch(i){console.error(i)}r.hide()},H=function(e){var o,n=t(this),r=t(n.data("suggestInputSelector"));e.stopPropagation(),e.preventDefault(),console.info("$input",r),navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(e){o=[e.coords.latitude,e.coords.longitude],console.info(o);try{r.length&&(r.val(""),r.data("center",o)),c&&m.is(":visible")?c.setCenter(o,13):t(".js-order-delivery-point-tab-link").trigger("update",[!1])}catch(n){console.error(n)}})},U=function(e){var o=t(e);o.validate({rules:{"user[email]":{required:!0,email:!0}},messages:{"user[email]":{required:"Введите email",email:"Введите email в формате name@email.ru"}},highlight:function(e,o,n){console.log("error!"),t(e).parent().addClass(o).removeClass(n)},unhighlight:function(e,o,n){t(e).parent().removeClass(o).addClass(n)},errorPlacement:function(e,t){if("checkbox"!==t.attr("type")){var o=t.parent();e.insertAfter(o),console.log("error-pl")}},submitHandler:function(e){var o=t(e).attr("action");return t.ajax({type:"POST",url:o,data:t(e).serialize(),success:l}),!1},ignore:""})};p.on("click",".js-order-delivery-form-control",function(e){var o=t(this),n=o.data("value");console.info("changeSplit",o),e.stopPropagation(),e.preventDefault(),n&&D(n)}),p.on("click",".js-order-delivery-pointPopup-link",J),p.on("click",".js-order-delivery-addressPopup-link",L),p.on("click",".js-order-delivery-discountPopup-link",$),p.on("click",".js-order-delivery-point-tab-link",A),p.on("update",".js-order-delivery-point-tab-link",A),p.on("click",".js-order-delivery-celendar-link",V),p.on("update",".js-order-delivery-map-container",q),p.on("update",".js-order-delivery-point-container",I),p.on("change",".js-order-delivery-point-filter",z),p.on("input",".js-order-delivery-point-search-input",_),p.on("click",".js-order-delivery-suggest-item",F),p.on("click",".js-order-delivery-geolocation-link",H),p.on("submit",".js-smartAddress-form",function(e){var o=t(this),n=o.serializeArray();e.stopPropagation(),e.preventDefault(),D(n)}),p.on("submit",".js-discount-form",function(e){var o=t(this),n=o.serializeArray(),r=o.data("checkUrl");r?t.ajax({url:r,data:{code:o.find('[data-field="number"]').val()},type:"post",timeout:15e3}).done(function(e){!0===e.success?D(n):!0===e.showPin?(o.find('[data-field-container="pin"]').show(),o.find('[data-field="pin"]').focus()):D(n)}).always(function(){console.info("unblock screen")}).error(function(){D(n)}):D(n),e.stopPropagation(),e.preventDefault()}),p.on("DOMNodeInserted",C,function(){t("[data-scroll]").scroll(function(){clearTimeout(t.data(this,"scrollTimer")),t("[data-scroll-wrap]").addClass("scrolling"),t.data(this,"scrollTimer",setTimeout(function(){t("[data-scroll-wrap]").removeClass("scrolling")},600))})}),p.on("submit",".js-order-form",function(e){var o=t(this),n=o.find('[data-field="accept"]');e.stopPropagation(),n.length&&(n.is(":checked")?n.removeClass("error"):(n.addClass("error"),e.preventDefault()))}),t.mask.definitions.x="[0-9]",t(".js-field-phone").mask("+7(xxx)xxx-xx-xx",{placeholder:"+7(xxx)xxx-xx-xx"}),t(".js-field-mnogoru").mask("xxxx xxxx",{placeholder:"xxxx xxxx"}),t.validator.messages.required="Поле не заполнено!",t(".js-validate").each(function(e,t){U(t)});try{navigator.geolocation||t(".js-order-delivery-geolocation-link").hide()}catch(Y){console.error(Y)}});