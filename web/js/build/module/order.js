define(["require","jquery","underscore","mustache","module/util","jquery.maskedinput","module/order/user.form","module/order/common","module/order/toggle","jquery.modal"],function(e,o,t,n){var a=o("body"),r=o(".js-order-delivery-form"),l=o("#yandexMap"),i=(o("#yandexMap-container"),function(e){e.geoObjects.events.remove("click"),e.geoObjects.events.add("click",function(t){var a=t.get("target"),r=o("#tpl-order-delivery-marker-balloon");console.info("placemark",a,a.properties.get("point")),e.balloon.open(t.get("coords"),n.render(r.html(),a.properties.get("point")))})}),c=function(e){e.stopPropagation();var t=o(this);o.ajax({url:r.attr("action"),data:t.data("value"),type:"post",timeout:3e4}).done(function(e){o(r.data("containerSelector")).html(e)}).always(function(){console.info("unblock screen")}),e.preventDefault()},d=function(t){t.stopPropagation(),o(".js-modal-open").modal();var a=o(this),r=o(".js-modal-content"),l=o("#tpl-order-delivery-point-popup"),i=o.parseJSON(o(a.data("dataSelector")).html());r.append(n.render(l.html(),i)),t.preventDefault(),e(["yandexmaps"],function(){})},p=function(e){e.stopPropagation(),o(".js-modal-open").modal();var t=o(this),a=o(".js-modal-content"),r=o("#tpl-order-delivery-calendar"),l=o.parseJSON(o(t.data("dataSelector")).html());a.append(n.render(r.html(),l))},s=function(n){n.stopPropagation();var a=o(n.currentTarget),r=o(a.data("containerSelector")),c=a.data("mapData");e(["module/yandexmaps"],function(e){e.initMap(l,c,i).done(function(n){var i,d=o.parseJSON(o(a.data("dataSelector")).html()).points;n.setCenter([c.center.lat,c.center.lng],c.zoom),n.balloon.close(),n.geoObjects.removeAll(),n.container.fitToViewport(),t.each(d,function(o){try{i=new e.ymaps.Placemark([o.lat,o.lng],{point:o,hintContent:o.name},{iconLayout:"default#image",iconImageHref:"/img/markers/"+o.icon,iconImageSize:[28,39],iconImageOffset:[-14,-39],zIndex:"shops"==o.group.token?1e3:0}),n.geoObjects.add(i)}catch(t){console.error(t)}}),r.append(l)})})};a.on("click",".js-order-delivery-form-control",c),a.on("click",".js-order-delivery-pointPopup-link",d),a.on("click",".js-order-delivery-map-link",s),a.on("click",".js-order-delivery-celendar-link",p)});