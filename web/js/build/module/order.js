define(["require","jquery","underscore","mustache","module/util","jquery.maskedinput","module/order/user.form","module/order/common","module/order/toggle"],function(e,o,t,n){var a=o("body"),d=o(".js-order-delivery-form"),r=o("#yandexMap"),i=o("#yandexMap-container"),l=o("#tpl-order-delivery-marker-balloon"),p=o("#tpl-order-delivery-point-popup"),c=o("#tpl-order-delivery-calendar"),s=o("#tpl-order-delivery-address-popup"),m=o("#tpl-modalWindow"),u=o("#tpl-order-delivery-discount-popup"),f=function(e){e.geoObjects.events.remove("click"),e.geoObjects.events.add("click",function(o){var t=o.get("target");console.info("placemark",t,t.properties.get("point")),e.balloon.open(o.get("coords"),n.render(l.html(),t.properties.get("point")))})},v=function(e){e.stopPropagation();var t=o(e.currentTarget);t.data("value")&&o.ajax({url:d.attr("action"),data:t.data("value"),type:"post",timeout:3e4}).done(function(e){o(d.data("containerSelector")).html(e)}).always(function(){console.info("unblock screen")}),e.preventDefault()},g=function(t){t.stopPropagation();var d=o(this),l=o.parseJSON(o(d.data("dataSelector")).html()),c=o(m.html()).appendTo(a),s=d.data("modal-title"),u=d.data("modal-position");c.find(".js-modal-title").text(s),c.addClass(u),c.lightbox_me({onLoad:function(){c.find(".js-modal-content").append(n.render(p.html(),l)),a.css({overflow:"hidden"})},beforeClose:function(){i.append(r),a.css({overflow:"auto"})},centered:!1}),t.preventDefault(),e(["yandexmaps"],function(){})},h=function(){var e=o(this),t=o(m.html()).appendTo(a),d=e.data("modal-title"),r=e.data("modal-position"),i={};t.find(".js-modal-title").text(d),t.addClass(r),t.lightbox_me({onLoad:function(){t.find(".js-modal-content").append(n.render(s.html(),i))},modalCSS:{top:"60px"}})},y=function(e){e.stopPropagation();var t=o(this),d=o.parseJSON(o(t.data("dataSelector")).html()),r=o(m.html()).appendTo(a),i=t.data("modal-title"),l=t.data("modal-position");r.find(".js-modal-title").text(i),r.addClass(l),r.lightbox_me({onLoad:function(){r.find(".js-modal-content").append(n.render(c.html(),d))}})},j=function(e){e.stopPropagation(),console.info("showDiscountPopup");var t=o(this),d={},r=o(m.html()).appendTo(a),i=t.data("modal-title"),l=t.data("modal-position");r.find(".js-modal-title").text(i),r.addClass(l),r.lightbox_me({onLoad:function(){r.find(".js-modal-content").append(n.render(u.html(),d))},centered:!1}),e.preventDefault()},k=function(n){n.stopPropagation();var a=o(n.currentTarget),d=a.find(".js-order-delivery-map-link-text"),i=o(a.data("containerSelector")),l=o(".js-order-points-container"),p=a.data("mapData"),c="show-map";l.toggleClass(c),d.text(o(".js-order-points-containet-type:hidden").data("order-points-type")),e(["module/yandexmaps"],function(e){e.initMap(r,p,f).done(function(n){var d,l=o.parseJSON(o(a.data("dataSelector")).html()).points;n.setCenter([p.center.lat,p.center.lng],p.zoom),n.balloon.close(),n.geoObjects.removeAll(),n.container.fitToViewport(),t.each(l,function(o){try{d=new e.ymaps.Placemark([o.lat,o.lng],{point:o,hintContent:o.name},{iconLayout:"default#image",iconImageHref:"/img/markers/"+o.icon,iconImageSize:[28,39],iconImageOffset:[-14,-39],zIndex:"shops"==o.group.token?1e3:0}),n.geoObjects.add(d)}catch(t){console.error(t)}}),i.append(r)})})};a.on("click",".js-order-delivery-form-control",v),a.on("click",".js-order-delivery-pointPopup-link",g),a.on("click",".js-order-delivery-addressPopup-link",h),a.on("click",".js-order-delivery-discountPopup-link",j),a.on("click",".js-order-delivery-map-link",k),a.on("click",".js-order-delivery-celendar-link",y)});