define(["require","jquery","underscore","mustache","module/util","module/config","jquery.ui","jquery.maskedinput","module/order/user.form","module/order/common","module/order/toggle"],function(e,t,n,o,r,a){var i={cache:{},get:function(e,n){var o=e+"-"+n,r=i.cache[o]?i.cache[o]:t.parseJSON(t(e).html());return i.cache[o]||(i.cache[o]=r),r},set:function(e,t,n){var o=e+"-"+t;i.cache[o]=n},clear:function(){i.cache={}}},d=null,l=null,c=null,s=t("body"),p=t(".js-order-delivery-form"),u=t("#pointYandexMap"),f=t("#addressYandexMap"),m=t("#yandexMap-container"),g=t("#tpl-order-delivery-marker-balloon"),h=t("#tpl-order-delivery-point-popup"),v=t("#tpl-order-delivery-calendar"),y=t("#tpl-order-delivery-address-popup"),b=t("#tpl-order-delivery-point-suggest"),j=t("#tpl-order-delivery-discount-popup"),k=t("#tpl-modalWindow"),S=function(n,r){var a=t.Deferred();return l&&a.resolve(n),e(["yandexmaps"],function(e){e.ready(function(){try{l=new e.Map(n.attr("id"),{center:[r.center.lat,r.center.lng],zoom:r.zoom},{autoFitToViewport:"always"}),l.geoObjects.events.remove("click"),l.geoObjects.events.add("click",function(e){var t=e.get("target");l.balloon.open(e.get("coords"),o.render(g.html(),t.properties.get("point")))}),a.resolve(n)}catch(t){console.error(t),a.reject(t)}})}),a},x=function(n,o){var r=t.Deferred();return d&&r.resolve(n),e(["yandexmaps"],function(e){e.ready(function(){try{d=new e.Map(n.attr("id"),{center:[o.center.lat,o.center.lng],zoom:o.zoom},{autoFitToViewport:"always"}),r.resolve(n)}catch(t){console.error(t),r.reject(t)}})}),r},w=function(){var n=t.Deferred();return null!==c&&n.resolve(c),e(["yandexmaps"],function(e){e.ready(function(){try{c=e,n.resolve(c)}catch(t){console.error(t),n.reject(t)}})}),n},O=function(n){var o=n.find(".js-smartAddress-form"),r=t(o.data("kladrIdSelector")),i=t(o.data("mapContainerSelector"));e(["jquery.kladr"],function(){t.kladr.setDefault({token:a.kladr.token,key:a.kladr.key,type:t.kladr.type.street,parentType:t.kladr.type.city,parentId:a.kladr.city.id,parentInput:".js-smartAddress-form",select:function(){},check:function(e){t(this)},checkBefore:function(){var e=t(this);return t.trim(e.val())?void 0:!1},change:function(){var e=10,n=t.kladr.getAddress(".js-smartAddress-form",function(n){var o=a.kladr.city.name+"";return r.length&&("object"===t.type(n.building)?r.val(n.building.id):"object"===t.type(n.street)&&r.val(n.street.id)),"object"===t.type(n.street)?t.each(n,function(n,r){var a="",i="";if("object"===t.type(r))switch(a=r.name,i=" "+r.type,r.contentType){case t.kladr.type.city:e=10;break;case t.kladr.type.street:e=13;break;case t.kladr.type.building:e=16}else a=r;o&&(o+=", "),o+=i+""+a}):o="",o});J(i,n,e)}}),o.find(".js-smartAddress-input").each(function(e,n){var o=t(n);o.kladr("type",o.data("kladrType"))})})},C=function(e){t.ajax({url:p.attr("action"),data:e,type:"post",timeout:4e4}).done(function(e){t(p.data("containerSelector")).html(e)}).always(function(){console.info("unblock screen")}).error(function(e){var n,o;e&&302===e.status&&(n=t.parseJSON(e.responseText)||{},o=n.redirect||"/cart",window.location.href=o)}),i.clear(),s.trigger("beforeSplit")},P=function(e,n){var o,r,a=t(this),d=parseInt(a.data("index")),l=t(a.data("filterFormSelector"));e.stopPropagation(),!1!==n&&(d=0==d?1:0),o=a.find('[data-index="'+d+'"]'),r=t(o.data("containerSelector")),a.data("index",d),a.find("[data-index]").each(function(e,n){var o=t(n);o.hide(),t(o.data("containerSelector")).hide()}),z(a.data("storageSelector"),l),o.show(),r.show().trigger("update",[i.get(a.data("storageSelector"),"filtered")])},T=function(e,o){var r=t(this),a=r.data("mapOption"),i=function(){var e;console.info("update point map ..."),r.find("#"+u.attr("id")).length||r.append(u),l.setCenter([a.center.lat,a.center.lng],a.zoom),l.balloon.close(),l.geoObjects.removeAll(),l.container.fitToViewport(),n.each(o.points,function(t){try{e=new ymaps.Placemark([t.lat,t.lng],{point:t,hintContent:t.name},{iconLayout:"default#image",iconImageHref:"/img/markers/"+t.icon,iconImageSize:[28,39],iconImageOffset:[-14,-39],zIndex:"shops"==t.group.token?1e3:0}),l.geoObjects.add(e)}catch(n){console.error(n,t)}})};l?i():S(u,a).done(i)},A=function(e,n){var r=t(this),a=h.data("partial")["page/order/delivery/point-list"];console.info("update point list ..."),r.html(o.render(a,n)),r.find(".content-scroll").scrollTop(),console.info("$scroll",r.find(".content-scroll"))},D=function(){var e=t(this),n=t(e.data("formSelector")),o=t(n.data("tabSelector"));o.trigger("update",[!1])},z=function(e,o){var r,a,d,l,c=t(o.data("suggestInputSelector")).data("center")||null,s=i.get(e,"base"),p=I(o),u={};if(n.extend(u,s),u.points=s.points.filter(function(e){for(r in e)if(p[r]&&p[r].length&&e[r]&&e[r].hasOwnProperty("value")&&(a=p[r].indexOf(e[r].value.toString()),-1===a))return!1;return!0}),c)try{n.each(u.points,function(e){d=Math.abs(e.lat-c[0]),l=Math.abs(e.lng-c[1]),e.distance=Math.sqrt(d*d+l*l),e.distance>.2,console.info(e.name+" "+e.distance)}),u.points.sort(function(e,t){return e.distance-t.distance})}catch(f){console.error(f)}i.set(e,"filtered",u)},I=function(e){var n=e.find("input"),o={};return n.each(function(e){var n=t(this),r=n.data("value");e=r.name,"undefined"==typeof o[e]&&(o[e]=[]),1==n.prop("checked")&&o[e].push(r.value.toString())}),o},q=function(n){var r=t(this),a=t(k.html()).appendTo(s),d=i.get(r.data("storageSelector"),"filtered"),l=r.data("modal-title"),c=r.data("modal-position"),p=function(){a.trigger("close")};n.stopPropagation(),a.find(".js-modal-title").text(l),a.addClass(c),a.lightbox_me({onLoad:function(){a.find(".js-modal-content").append(o.render(h.html(),d,h.data("partial")))},beforeClose:function(){m.append(u),s.off("beforeSplit",p)}}),s.on("beforeSplit",p),n.preventDefault(),setTimeout(function(){e(["yandexmaps"],function(){})},1e3)},M=function(n){var r=t(this),a=t(k.html()).appendTo(s),i=r.data("modal-title"),d=r.data("modal-position"),l=t.parseJSON(t(r.data("dataSelector")).html()),c=function(){a.trigger("close")};n.stopPropagation(),e(["jquery.kladr"],function(){}),e(["yandexmaps"],function(){}),a.find(".js-modal-title").text(i),a.addClass(d),a.lightbox_me({onLoad:function(){a.find(".js-modal-content").append(o.render(y.html(),l)),O(a),e(["yandexmaps"],function(){var e=t(r.data("mapContainerSelector"));J(e)})},beforeClose:function(){m.append(f),s.off("beforeSplit",c)},modalCSS:{top:"60px"}}),s.on("beforeSplit",c)},J=function(t,n,o){var r=t.data("mapOption"),a=function(){console.info("update address map ..."),t.find("#"+f.attr("id")).length||t.append(f),d.balloon.close(),d.geoObjects.removeAll(),d.container.fitToViewport()};d?a():x(f,r).done(a),n&&e(["yandexmaps"],function(e){if(d){var t=e.geocode(n);t.then(function(t){d.balloon.close(),d.geoObjects.removeAll();var n=t.geoObjects.get(0).geometry.getCoordinates(),r=new e.Placemark(n,{},{});d.geoObjects.add(r),d.setCenter(n,o)})}})},N=function(e){var n=t(this),r=t.parseJSON(t(n.data("dataSelector")).html()),a=t(k.html()).appendTo(s),i=n.data("modal-title"),d=n.data("modal-position"),l=function(){a.trigger("close")};e.stopPropagation(),a.find(".js-modal-title").text(i),a.addClass(d),a.lightbox_me({fullScreen:!0,modal:!1,onLoad:function(){a.find(".js-modal-content").append(o.render(v.html(),r))},beforeClose:function(){s.off("beforeSplit",l)}}),s.on("beforeSplit",l)},B=function(e){var n,r=t(this),a=t.parseJSON(t(r.data("storageSelector")).html()),i=t(k.html()).appendTo(s),d=r.data("modal-title"),l=r.data("modal-position"),c=function(){i.trigger("close")};e.stopPropagation(),i.find(".js-modal-title").text(d),i.addClass(l),i.lightbox_me({onLoad:function(){i.find(".js-modal-content").append(o.render(j.html(),a)),n=t(".js-user-discount-container"),n.length&&n.data("url")&&t.get(n.data("url")).done(function(e){n.html(e.content);var o=i.find(".js-discount-form");o.length&&n.on("click",".js-user-discount",function(e){var n=t(this),r=n.data("value");$field=o.find('[data-field="number"]'),e.preventDefault(),e.stopPropagation(),$field.val(r)})})},beforeClose:function(){s.off("beforeSplit",c)},centered:!1}),s.on("beforeSplit",c),e.preventDefault()},L=function(e){var n=t(this),r=n.val(),i=n.data("suggestContainerSelector"),d=t(i),c={items:[]},s={};e.stopPropagation(),n.data("center",null),w().done(function(e){if(r.length>1){try{r=a.kladr.city.name+", "+r}catch(t){console.error(t)}l&&(s={boundedBy:l.geoObjects.getBounds(),strictBounds:!0}),e.geocode(r,s).then(function(e){e.geoObjects.each(function(e){c.items.push({name:e.properties.get("name"),dataCenterValue:JSON.stringify(e.geometry.getBounds()[0]).replace(/\"/g,"&quot;"),containerSelector:i})}),d.html(o.render(b.html(),c)),d.show()},function(e){console.warn("Geocode error",e)})}})},V=function(e){var n=t(this),o=n.data("center"),r=t(n.data("containerSelector")),a=t(r.data("inputSelector"));e.stopPropagation(),e.preventDefault(),console.info("center",o);try{o&&(a.length&&(a.val(n.text()),a.data("center",o)),l?l.setCenter(o,14):t(".js-order-delivery-point-tab-link").trigger("update",[!1]))}catch(i){console.error(i)}r.hide()};s.on("click",".js-order-delivery-form-control",function(e){var n=t(this),o=n.data("value");console.info("changeSplit",n),e.stopPropagation(),e.preventDefault(),o&&C(o)}),s.on("click",".js-order-delivery-pointPopup-link",q),s.on("click",".js-order-delivery-addressPopup-link",M),s.on("click",".js-order-delivery-discountPopup-link",B),s.on("click",".js-order-delivery-point-tab-link",P),s.on("update",".js-order-delivery-point-tab-link",P),s.on("click",".js-order-delivery-celendar-link",N),s.on("update",".js-order-delivery-map-container",T),s.on("update",".js-order-delivery-point-container",A),s.on("change",".js-order-delivery-point-filter",D),s.on("input",".js-order-delivery-point-search-input",L),s.on("click",".js-order-delivery-suggest-item",V),s.on("submit",".js-smartAddress-form",function(e){var n=t(this),o=n.serializeArray();e.stopPropagation(),e.preventDefault(),C(o)}),s.on("submit",".js-discount-form",function(e){var n=t(this),o=n.serializeArray(),r=n.data("checkUrl");r?t.ajax({url:r,data:{code:n.find('[data-field="number"]').val()},type:"post",timeout:15e3}).done(function(e){!0===e.success?C(o):!0===e.showPin?(n.find('[data-field-container="pin"]').show(),n.find('[data-field="pin"]').focus()):C(o)}).always(function(){console.info("unblock screen")}).error(function(){C(o)}):C(o),e.stopPropagation(),e.preventDefault()})});