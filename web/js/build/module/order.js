define(["require","jquery","underscore","mustache","module/util","module/config","jquery.maskedinput","module/order/user.form","module/order/common","module/order/toggle"],function(e,t,n,o,a,r){var i={cache:{},get:function(e,n){var o=e+"-"+n,a=i.cache[o]?i.cache[o]:t.parseJSON(t(e).html());return i.cache[o]||(i.cache[o]=a),a},set:function(e,t,n){var o=e+"-"+t;i.cache[o]=n}},d=null,l=null,c=t("body"),s=t(".js-order-delivery-form"),p=t("#pointYandexMap"),u=t("#addressYandexMap"),f=t("#yandexMap-container"),m=t("#tpl-order-delivery-marker-balloon"),v=t("#tpl-order-delivery-point-popup"),h=t("#tpl-order-delivery-calendar"),y=t("#tpl-order-delivery-address-popup"),g=t("#tpl-modalWindow"),k=t("#tpl-order-delivery-discount-popup"),j=function(n,a){var r=t.Deferred();return l&&r.resolve(n),e(["yandexmaps"],function(e){e.ready(function(){try{l=new e.Map(n.attr("id"),{center:[a.center.lat,a.center.lng],zoom:a.zoom},{autoFitToViewport:"always"}),l.geoObjects.events.remove("click"),l.geoObjects.events.add("click",function(e){var t=e.get("target");l.balloon.open(e.get("coords"),o.render(m.html(),t.properties.get("point")))}),r.resolve(n)}catch(t){console.error(t),r.reject(t)}})}),r},b=function(n,o){var a=t.Deferred();return d&&a.resolve(n),e(["yandexmaps"],function(e){e.ready(function(){try{d=new e.Map(n.attr("id"),{center:[o.center.lat,o.center.lng],zoom:o.zoom},{autoFitToViewport:"always"}),a.resolve(n)}catch(t){console.error(t),a.reject(t)}})}),a},x=function(n){var o=n.find(".js-smartAddress-form"),a=t(o.data("mapContainerSelector"));console.info("$mapContainer",a),e(["jquery.kladr"],function(){t.kladr.setDefault({token:r.kladr.token,key:r.kladr.key,type:t.kladr.type.street,parentType:t.kladr.type.city,parentId:r.kladr.city.id,parentInput:".js-smartAddress-form",verify:!0,select:function(){},check:function(e){t(this)},checkBefore:function(){var e=t(this);return t.trim(e.val())?void 0:!1},change:function(e){console.info(e),I(a,o)}}),o.find(".js-smartAddress-input").each(function(e,n){var o=t(n);o.kladr("type",o.data("kladrType"))})})},S=function(e){t.ajax({url:s.attr("action"),data:e,type:"post",timeout:3e4}).done(function(e){t(s.data("containerSelector")).html(e)}).always(function(){console.info("unblock screen")})},w=function(e,n){var o,a,r=t(this),d=parseInt(r.data("index")),l=t(r.data("filterFormSelector"));!1!==n&&(d=0==d?1:0),o=r.find('[data-index="'+d+'"]'),a=t(o.data("containerSelector")),r.data("index",d),r.find("[data-index]").each(function(e,n){var o=t(n);o.hide(),t(o.data("containerSelector")).hide()}),P(r.data("storageSelector"),l),o.show(),a.show().trigger("update",[i.get(r.data("storageSelector"),"filtered")])},C=function(e,o){var a=t(this),r=a.data("mapOption"),i=function(){var e;console.info("update point map ..."),a.find("#"+p.attr("id")).length||a.append(p),l.setCenter([r.center.lat,r.center.lng],r.zoom),l.balloon.close(),l.geoObjects.removeAll(),l.container.fitToViewport(),n.each(o.points,function(t){try{e=new ymaps.Placemark([t.lat,t.lng],{point:t,hintContent:t.name},{iconLayout:"default#image",iconImageHref:"/img/markers/"+t.icon,iconImageSize:[28,39],iconImageOffset:[-14,-39],zIndex:"shops"==t.group.token?1e3:0}),l.geoObjects.add(e)}catch(n){console.error(n,t)}})};l?i():j(p,r).done(i)},O=function(e,n){var a=t(this),r=v.data("partial")["page/order/delivery/point-list"];console.info("update point list ..."),a.html(o.render(r,n))},T=function(){var e=t(this),n=t(e.data("formSelector")),o=t(n.data("tabSelector"));console.info("$tab",o),o.trigger("update",[!1])},P=function(e,t){var o,a,r=i.get(e,"base"),d=A(t),l={};n.extend(l,r),l.points=r.points.filter(function(e){for(o in e)if(d[o]&&d[o].length&&e[o]&&e[o].hasOwnProperty("value")&&(a=d[o].indexOf(e[o].value.toString()),-1===a))return!1;return!0}),i.set(e,"filtered",l)},A=function(e){var n=e.find("input"),o={};return n.each(function(e){var n=t(this),a=n.data("value");e=a.name,"undefined"==typeof o[e]&&(o[e]=[]),1==n.prop("checked")&&o[e].push(a.value.toString())}),o},z=function(n){var a=t(this),r=t(g.html()).appendTo(c),d=i.get(a.data("storageSelector"),"filtered"),l=a.data("modal-title"),s=a.data("modal-position");n.stopPropagation(),r.find(".js-modal-title").text(l),r.addClass(s),r.lightbox_me({onLoad:function(){r.find(".js-modal-content").append(o.render(v.html(),d,v.data("partial"))),c.css({overflow:"hidden",position:"fixed"})},beforeClose:function(){f.append(p),c.css({overflow:"auto"})},centered:!1}),n.preventDefault(),setTimeout(function(){e(["yandexmaps"],function(){})},1e3)},D=function(){var n=t(this),a=t(g.html()).appendTo(c),r=n.data("modal-title"),i=n.data("modal-position"),d=t.parseJSON(t(n.data("dataSelector")).html());e(["jquery.kladr"],function(){}),e(["yandexmaps"],function(){}),a.find(".js-modal-title").text(r),a.addClass(i),a.lightbox_me({onLoad:function(){a.find(".js-modal-content").append(o.render(y.html(),d)),x(a),e(["yandexmaps"],function(){var e=t(n.data("mapContainerSelector"));console.info("$mapContainer",e,e.data()),I(e)})},beforeClose:function(){f.append(p)},modalCSS:{top:"60px"}})},I=function(n){var o=4,a=t.kladr.getAddress(".js-smartAddress-form",function(e){var n="";return t.each(e,function(e,a){var r="",i="";if("object"===t.type(a))switch(r=a.name,i=" "+a.type,a.contentType){case t.kladr.type.city:o=10;break;case t.kladr.type.street:o=13;break;case t.kladr.type.building:o=16}else r=a;n&&(n+=", "),n+=i+" "+r}),n}),r=n.data("mapOption"),i=function(){console.info("update address map ..."),n.find("#"+u.attr("id")).length||n.append(u),d.setCenter([r.center.lat,r.center.lng],r.zoom),d.balloon.close(),d.geoObjects.removeAll(),d.container.fitToViewport()};d?i():b(u,r).done(i),a&&e(["yandexmaps"],function(e){var t=e.geocode(a);d&&t.then(function(t){d.balloon.close(),d.geoObjects.removeAll();var n=t.geoObjects.get(0).geometry.getCoordinates(),a=new e.Placemark(n,{},{});d.geoObjects.add(a),d.setCenter(n,o)})})},q=function(e){e.stopPropagation();var n=t(this),a=t.parseJSON(t(n.data("dataSelector")).html()),r=t(g.html()).appendTo(c),i=n.data("modal-title"),d=n.data("modal-position");r.find(".js-modal-title").text(i),r.addClass(d),r.lightbox_me({onLoad:function(){r.find(".js-modal-content").append(o.render(h.html(),a))}})},L=function(e){e.stopPropagation(),console.info("showDiscountPopup");var n,a=t(this),r={},i=t(g.html()).appendTo(c),d=a.data("modal-title"),l=a.data("modal-position");i.find(".js-modal-title").text(d),i.addClass(l),i.lightbox_me({onLoad:function(){i.find(".js-modal-content").append(o.render(k.html(),r)),n=t(".js-user-discount-container"),n.length&&n.data("url")&&t.get(n.data("url")).done(function(e){n.html(e.content)})},centered:!1}),e.preventDefault()},M=function(){t.ajax({url:s.attr("action"),data:$form.serializeArray(),type:"post",timeout:3e4}).done(function(){}).always(function(){console.info("unblock screen")})};c.on("click",".js-order-delivery-form-control",function(e){var n=t(e.currentTarget),o=n.data("value");e.stopPropagation(),e.preventDefault(),o&&S(o)}),c.on("click",".js-order-delivery-pointPopup-link",z),c.on("click",".js-order-delivery-addressPopup-link",D),c.on("click",".js-order-delivery-discountPopup-link",L),c.on("click",".js-order-delivery-point-tab-link",w),c.on("update",".js-order-delivery-point-tab-link",w),c.on("click",".js-order-delivery-celendar-link",q),c.on("update",".js-order-delivery-map-container",C),c.on("update",".js-order-delivery-point-container",O),c.on("change",".js-order-delivery-point-filter",T),c.on("submit",".js-smartAddress-form",function(e){var n=t(this),o=n.serializeArray();e.stopPropagation(),e.preventDefault(),S(o)}),c.on("submit",".js-certificate-check",M)});