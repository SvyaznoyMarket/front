define(["require","jquery","underscore","mustache","module/util","jquery.maskedinput","module/order/user.form","module/order/common","module/order/toggle"],function(e,o,t,n){var r=o("body"),a=o(".js-order-delivery-form"),d=o("#yandexMap"),l=o("#yandexMap-container"),i=o("#tpl-order-delivery-marker-balloon"),c=o("#tpl-order-delivery-point-popup"),p=o("#tpl-order-delivery-calendar"),s=(o("#tpl-order-delivery-address-popup"),o("#tpl-modalWindow")),u=o("#tpl-order-delivery-discount-popup"),m=function(e){e.geoObjects.events.remove("click"),e.geoObjects.events.add("click",function(o){var t=o.get("target");console.info("placemark",t,t.properties.get("point")),e.balloon.open(o.get("coords"),n.render(i.html(),t.properties.get("point")))})},f=function(e){e.stopPropagation();var t=o(e.currentTarget);t.data("value")&&o.ajax({url:a.attr("action"),data:t.data("value"),type:"post",timeout:3e4}).done(function(e){o(a.data("containerSelector")).html(e)}).always(function(){console.info("unblock screen")}),e.preventDefault()},v=function(t){t.stopPropagation();var a=o(this),i=o.parseJSON(o(a.data("dataSelector")).html()),p=o(s.html()).appendTo(r),u=a.data("modal-title");p.find(".js-modal-title").text(u),p.lightbox_me({onLoad:function(){p.find(".js-modal-content").append(n.render(c.html(),i))},beforeClose:function(){l.append(d)}}),t.preventDefault(),e(["yandexmaps"],function(){})},g=function(){var e={};n.render(c.html(),e)},y=function(e){e.stopPropagation();var t=o(this),a=o.parseJSON(o(t.data("dataSelector")).html()),d=o(s.html()).appendTo(r),l=t.data("modal-title"),i=t.data("modal-position");d.find(".js-modal-title").text(l),d.addClass(i),d.lightbox_me({onLoad:function(){d.find(".js-modal-content").append(n.render(p.html(),a))},centered:!0})},h=function(){var e={};console.info("showDiscountPopup"),n.render(u.html(),e)},k=function(n){n.stopPropagation();var r=o(n.currentTarget),a=o(r.data("containerSelector")),l=r.data("mapData");e(["module/yandexmaps"],function(e){e.initMap(d,l,m).done(function(n){var i,c=o.parseJSON(o(r.data("dataSelector")).html()).points;n.setCenter([l.center.lat,l.center.lng],l.zoom),n.balloon.close(),n.geoObjects.removeAll(),n.container.fitToViewport(),t.each(c,function(o){try{i=new e.ymaps.Placemark([o.lat,o.lng],{point:o,hintContent:o.name},{iconLayout:"default#image",iconImageHref:"/img/markers/"+o.icon,iconImageSize:[28,39],iconImageOffset:[-14,-39],zIndex:"shops"==o.group.token?1e3:0}),n.geoObjects.add(i)}catch(t){console.error(t)}}),a.append(d)})})};r.on("click",".js-order-delivery-form-control",f),r.on("click",".js-order-delivery-pointPopup-link",v),r.on("click",".js-order-delivery-addressPopup-link",g),r.on("click",".js-order-delivery-discountPopup-link",h),r.on("click",".js-order-delivery-map-link",k),r.on("click",".js-order-delivery-celendar-link",y)});