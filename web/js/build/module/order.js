define(["require","jquery","underscore","mustache","module/util","module/config","jquery.maskedinput","module/order/user.form","module/order/common","module/order/toggle"],function(e,t,o,n,a,r){var i,d={cache:{},get:function(e,o){var n=e+"-"+o,a=d.cache[n]?d.cache[n]:t.parseJSON(t(e).html());return d.cache[n]||(d.cache[n]=a),a},set:function(e,t,o){var n=e+"-"+t;d.cache[n]=o}},l=t("body"),c=t(".js-order-delivery-form"),s=t("#yandexMap"),p=t("#yandexMap-container"),u=t("#tpl-order-delivery-marker-balloon"),f=t("#tpl-order-delivery-point-popup"),m=t("#tpl-order-delivery-calendar"),v=t("#tpl-order-delivery-address-popup"),y=t("#tpl-modalWindow"),h=t("#tpl-order-delivery-discount-popup"),g=function(e){e.geoObjects.events.remove("click"),e.geoObjects.events.add("click",function(t){var o=t.get("target");console.info("placemark",o,o.properties.get("point")),e.balloon.open(t.get("coords"),n.render(u.html(),o.properties.get("point")))})},k=function(o){var n=o.find(".js-smartAddress-form");e(["jquery.kladr"],function(){t.kladr.setDefault({token:r.kladr.token,key:r.kladr.key,type:t.kladr.type.street,parentType:t.kladr.type.city,parentId:r.kladr.city.id,parentInput:".js-smartAddress-form",verify:!0,select:function(){},check:function(e){t(this)},checkBefore:function(){var e=t(this);return t.trim(e.val())?void 0:!1},change:function(e){console.info(e),D(n)}}),n.find(".js-smartAddress-input").each(function(e,o){var n=t(o);n.kladr("type",n.data("kladrType"))})})},j=function(e){t.ajax({url:c.attr("action"),data:e,type:"post",timeout:3e4}).done(function(e){t(c.data("containerSelector")).html(e)}).always(function(){console.info("unblock screen")})},b=function(e){function o(e){for(n in e)if(c[n]&&c[n].length&&e[n]&&e[n].hasOwnProperty("value")&&(a=c[n].indexOf(e[n].value.toString()),-1===a))return!1;return!0}var n,a,r=t.parseJSON(t(e).html()),i=r.points,l={},c=x(e);return l.points=[i],l.points=i.filter(o),d.set(e,"filtered",l),l},x=function(e){var o=t(".js-order-filter-points-input").filter('[data-data-selector="'+e+'"]'),n={};return o.each(function(e){var o=t(this),a=o.data("value");e=a.name,"undefined"==typeof n[e]&&(n[e]=[]),1==o.prop("checked")&&n[e].push(a.value.toString())}),n},C=function(e){var o=f.data("partial")["page/order/delivery/point-list"],a=t(".js-order-points-container-type-points");a.html(n.render(o,e))},w=function(){var e=t(this),o=e.closest(".js-order-delivery-points-filter-params-list"),n="active";1==e.prop("checked")?o.addClass(n):o.removeClass(n)},O=function(e){var o=t(e.target),n=o.data("data-selector"),a=b(n),r=w.bind(o);C(a),P(a.points),r()},S=function(e){e.stopPropagation();var o=t(e.currentTarget),n=o.find(".js-order-delivery-map-link-text"),a=t(".js-order-points-container"),r=(o.data("data-selector"),d.get(o.data("dataSelector"),"filtered")),i="show-map";a.toggleClass(i),n.text(t(".js-order-points-container-type:hidden").data("order-points-type")),P(r.points)},P=function(n){var a=t(".js-order-points-container-type"),r=t(".js-order-delivery-map-link ").data("map-data");a.find("#yandexMap").length||a.append(s.show()),e(["module/yandexmaps"],function(e){e.initMap(s,r,g).done(function(t){var a;t.setCenter([r.center.lat,r.center.lng],r.zoom),t.balloon.close(),t.geoObjects.removeAll(),t.container.fitToViewport(),o.each(n,function(o){try{a=new e.ymaps.Placemark([o.lat,o.lng],{point:o,hintContent:o.name},{iconLayout:"default#image",iconImageHref:"/img/markers/"+o.icon,iconImageSize:[28,39],iconImageOffset:[-14,-39],zIndex:"shops"==o.group.token?1e3:0}),t.geoObjects.add(a)}catch(n){console.error(n,o)}})})})},T=function(o){o.stopPropagation();var a=t(this),r=t(y.html()).appendTo(l),i=d.get(a.data("dataSelector"),"filtered"),c=a.data("modal-title"),u=a.data("modal-position");r.find(".js-modal-title").text(c),r.addClass(u),r.lightbox_me({onLoad:function(){r.find(".js-modal-content").append(n.render(f.html(),i,f.data("partial"))),l.css({overflow:"hidden"}),r.on("change",".js-order-filter-points-input",O)},beforeClose:function(){p.append(s),l.css({overflow:"auto"})},centered:!1}),o.preventDefault(),setTimeout(function(){e(["module/yandexmaps"],function(){})},2500)},A=function(){var o=t(this),a=t(y.html()).appendTo(l),r=o.data("modal-title"),d=o.data("modal-position"),c=t.parseJSON(t(o.data("dataSelector")).html());e(["jquery.kladr"],function(){}),e(["module/yandexmaps"],function(){}),a.find(".js-modal-title").text(r),a.addClass(d),a.lightbox_me({onLoad:function(){a.find(".js-modal-content").append(n.render(v.html(),c)),k(a),function(o){var n=t(o.data("mapContainerSelector")),a=n.data("mapData");n.find("#yandexMap").length||n.append(s.show()),e(["module/yandexmaps"],function(e){e.initMap(s,a,g).done(function(e){e.setCenter([a.center.lat,a.center.lng],a.zoom),e.balloon.close(),e.geoObjects.removeAll(),e.container.fitToViewport(),i=e})})}(o)},beforeClose:function(){p.append(s)},modalCSS:{top:"60px"}})},D=function(){var o=4,n=t.kladr.getAddress(".js-smartAddress-form",function(e){var n="";return t.each(e,function(e,a){var r="",i="";if("object"===t.type(a))switch(r=a.name,i=" "+a.type,a.contentType){case t.kladr.type.city:o=10;break;case t.kladr.type.street:o=13;break;case t.kladr.type.building:o=16}else r=a;n&&(n+=", "),n+=i+" "+r}),n});n&&i&&e(["module/yandexmaps"],function(e){var t=e.ymaps.geocode(n);t.then(function(t){i.balloon.close(),i.geoObjects.removeAll();var n=t.geoObjects.get(0).geometry.getCoordinates(),a=new e.ymaps.Placemark(n,{},{});i.geoObjects.add(a),i.setCenter(n,o)})})},z=function(e){e.stopPropagation();var o=t(this),a=t.parseJSON(t(o.data("dataSelector")).html()),r=t(y.html()).appendTo(l),i=o.data("modal-title"),d=o.data("modal-position");r.find(".js-modal-title").text(i),r.addClass(d),r.lightbox_me({onLoad:function(){r.find(".js-modal-content").append(n.render(m.html(),a))}})},I=function(e){e.stopPropagation(),console.info("showDiscountPopup");var o,a=t(this),r={},i=t(y.html()).appendTo(l),d=a.data("modal-title"),c=a.data("modal-position");i.find(".js-modal-title").text(d),i.addClass(c),i.lightbox_me({onLoad:function(){i.find(".js-modal-content").append(n.render(h.html(),r)),o=t(".js-user-discount-container"),o.length&&o.data("url")&&t.get(o.data("url")).done(function(e){o.html(e.content)})},centered:!1}),e.preventDefault()},M=function(){t.ajax({url:c.attr("action"),data:$form.serializeArray(),type:"post",timeout:3e4}).done(function(){}).always(function(){console.info("unblock screen")})};l.on("click",".js-order-delivery-form-control",function(e){var o=t(e.currentTarget),n=o.data("value");e.stopPropagation(),e.preventDefault(),n&&j(n)}),l.on("click",".js-order-delivery-pointPopup-link",T),l.on("click",".js-order-delivery-addressPopup-link",A),l.on("click",".js-order-delivery-discountPopup-link",I),l.on("click",".js-order-delivery-map-link",S),l.on("click",".js-order-delivery-celendar-link",z),l.on("submit",".js-smartAddress-form",function(e){var o=t(this),n=o.serializeArray();e.stopPropagation(),e.preventDefault(),j(n)}),l.on("submit",".js-certificate-check",M)});