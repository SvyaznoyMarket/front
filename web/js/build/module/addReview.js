define(["jquery","mustache","module/config","module/util","jquery.popup","jquery.maskedinput"],function(e,r){function t(t){function n(e){return r.render(I,e)}function i(e){var r=e||{productName:C.productName,productId:C.productId};j.content.append(n(r))}function a(){j.jsContentHidden.toggleClass("hidden")}function c(r){if(r.preventDefault(),u()){for(var t=e(this).serializeArray(),n=0,o=t.length;o>n;n++)x[t[n].name]=t[n].value;x.productId=C.productId,e.ajax({url:k.reviewForm.prop("action"),type:"post",data:{review:x},beforeSend:function(){k.error&&k.error.remove()},error:function(){},success:function(r){if(r.success)l(),h("confirm");else if(r.error){var t=k.error=e('<div class="error">При заполнении формы допущены ошибки</div>');k.reviewsWrap.prepend(t),w()}}})}}function u(){for(var r=[],t=[e('input[name="author"]'),e('input[name="email"]'),e('textarea[name="pros"]'),e('textarea[name="cons"]'),e('textarea[name="extract"]')],n=0,o=t.length;o>n;n++)""===t[n].val()?(t[n].addClass("fieldError"),r.push(t[n])):t[n].removeClass("fieldError");return 0===r.length}function s(){var r=k.reviewMarkItem.index(e(this));k.reviewMarkItem.slice(0,++r).addClass("mark-full"),k.reviewMarkItem.slice(r).removeClass("mark-full")}function d(r){r.preventDefault(),x.score=2*(k.reviewMarkItem.index(e(this))+1)}function v(){k.reviewMarkItem.hover(s),k.reviewMarkItem.click(d),k.reviewForm.submit(c),k.closeReviewFormBtn.click(f)}function p(){k=e.extend(k,{jsAddReviewPopup:e(".js-addReviewPopup"),reviewMarkItem:e(".reviews-mark__item"),reviewForm:e("#review-form"),closeReviewFormBtn:e(".js-close-review-form"),reviewsWrap:e(".reviews-wrap")})}function m(){k.jsAddReviewPopup.show()}function l(){k.jsAddReviewPopup.remove(),a()}function f(e){e.preventDefault(),l()}function w(){o.scrollTo(0)}function h(e){var r="confirm"===e?{success:!0}:{};i(r),a(),p(),v(),m(),w()}var j={content:e(".js-content"),jsContentHidden:e(".js-content-hidden")},k={},I=e("#tpl-product-addReviewForm").html(),x={score:1,author:"",email:"",pros:"",cons:"",extract:""},C=t;!function(){h()}()}function n(r){r.preventDefault(),new t({productName:e(this).data("productName"),productId:e(this).data("productId")})}var o=e("body");o.on("click",".js-reviews-add",n)});