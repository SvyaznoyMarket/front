define(["jquery","mustache","module/config","module/util","jquery.popup","jquery.maskedinput"],function(e,r,t,n){function o(t){function n(e){return r.render(R,e)}function o(e){C.content.append(n(e))}function a(){C.jsContentHidden.toggleClass("hidden")}function s(){"fixed"===C.header.css("position")?C.header.css("position","absolute"):"absolute"===C.header.css("position")&&C.header.css("position","fixed")}function u(r){if(r.preventDefault(),c()){for(var t=e(this).serializeArray(),n=0,o=t.length;n<o;n++)y[t[n].name]=t[n].value;y.productId=A.productId,e.ajax({url:M.reviewForm.prop("action"),type:"post",data:{review:y},beforeSend:function(){M.error&&M.error.remove()},error:function(){},success:function(r){if(r.success)x(),g("confirm");else if(r.error){var t=M.error=e('<div class="error">При заполнении формы допущены ошибки</div>');M.reviewsWrap.prepend(t),k()}}})}}function c(){function r(e){e.addClass("fieldError"),e.parents(".js-input-group").append('<span class="error-message">'+p(e.prop("name"))+"</span>"),n.push(e),t||(t=e)}for(var t,n=[],o=[e('input[name="author"]'),e('input[name="email"]'),e('textarea[name="pros"]'),e('textarea[name="cons"]'),e('textarea[name="extract"]')],a=0,i=o.length;a<i;a++)if("email"==o[a].prop("name")){var s=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;s.test(o[a].val())||r(o[a])}else""===o[a].val()?r(o[a]):(o[a].removeClass("fieldError"),o[a].parents(".js-input-group").find(".error-message").remove());return t&&d(t),0===n.length}function d(e){var r=20;i.scrollTo(e.offset().top-r)}function p(e){var r={author:"Не указано имя",email:"Неверный e-mail",pros:"Не указаны достоинства",cons:"Не указаны недостатки",extract:"Не указан комментарий",unknown:"Не заполнено поле"};switch(e){case"author":return r.author;case"email":return r.email;case"pros":return r.pros;case"cons":return r.cons;case"extract":return r.extract;default:return r.unknown}}function f(){var r=M.reviewMarkItem.index(e(this));M.reviewMarkItem.slice(0,++r).addClass("mark-full"),M.reviewMarkItem.slice(r).removeClass("mark-full")}function m(r){r.preventDefault(),y.score=2*(M.reviewMarkItem.index(e(this))+1)}function l(){e(this).removeClass("fieldError"),e(this).parents(".js-input-group").find(".error-message").remove()}function v(){M.reviewMarkItem.hover(f),M.reviewMarkItem.click(m),M.textInput.focus(l),M.textarea.focus(l),M.reviewForm.submit(u),M.closeReviewFormBtn.click(j)}function w(){M=e.extend(M,{jsAddReviewPopup:e(".js-addReviewPopup"),reviewMarkItem:e(".reviews-mark__item"),reviewForm:e("#review-form"),closeReviewFormBtn:e(".js-close-review-form"),reviewsWrap:e(".reviews-wrap"),textInput:e("#review-form").find(".reviews-input"),textarea:e("#review-form").find("textarea")})}function h(){M.jsAddReviewPopup.show()}function x(){M.jsAddReviewPopup.remove(),a(),s(),k()}function j(e){e.preventDefault(),x()}function k(){i.scrollTo(0)}function I(e){var r={productName:A.productName,productId:A.productId};return _.extend(r,e)}function g(e){var r="confirm"===e?{success:!0}:{},t=I(r);o(t),a(),s(),w(),v(),h(),k()}var C={content:e(".js-content"),jsContentHidden:e(".js-content-hidden"),header:e(".header")},M={},R=e("#tpl-product-addReviewForm").html(),y={score:10,author:"",email:"",pros:"",cons:"",extract:""},A=t;!function(){g()}()}function a(r){r.preventDefault(),new o({productName:e(this).data("productName"),productId:e(this).data("productId")})}var i=e("body");i.on("click",".js-reviews-add",a)});