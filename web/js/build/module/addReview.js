define(["jquery","mustache","module/config","module/util","jquery.popup","jquery.maskedinput"],function(e,r){function t(t){function n(e){return r.render(x,e)}function a(e){var r=e||{productName:C.productName,productId:C.productId};k.content.append(n(r))}function i(){k.jsContentHidden.toggleClass("hidden")}function s(r){if(r.preventDefault(),u()){for(var t=e(this).serializeArray(),n=0,o=t.length;o>n;n++)g[t[n].name]=t[n].value;g.productId=C.productId,e.ajax({url:I.reviewForm.prop("action"),type:"post",data:{review:g},beforeSend:function(){I.error&&I.error.remove()},error:function(){},success:function(r){if(r.success)f(),j("confirm");else if(r.error){var t=I.error=e('<div class="error">При заполнении формы допущены ошибки</div>');I.reviewsWrap.prepend(t),h()}}})}}function u(){for(var r=[],t=[e('input[name="author"]'),e('input[name="email"]'),e('textarea[name="pros"]'),e('textarea[name="cons"]'),e('textarea[name="extract"]')],n=0,o=t.length;o>n;n++)""===t[n].val()?(t[n].addClass("fieldError"),t[n].parents(".js-input-group").append('<span class="error-message">'+c(t[n].prop("name"))+"</span>"),r.push(t[n])):(t[n].removeClass("fieldError"),t[n].parents(".js-input-group").find(".error-message").remove());return 0===r.length}function c(e){var r={author:"Не указано имя",email:"Неверный e-mail",pros:"Не указаны достоинства",cons:"Не указаны недостатки",extract:"Не указан комментарий",unknown:"Не заполнено поле"};switch(e){case"author":return r.author;case"email":return r.email;case"pros":return r.pros;case"cons":return r.cons;case"extract":return r.extract;default:return r.unknown}}function d(){var r=I.reviewMarkItem.index(e(this));I.reviewMarkItem.slice(0,++r).addClass("mark-full"),I.reviewMarkItem.slice(r).removeClass("mark-full")}function p(r){r.preventDefault(),g.score=2*(I.reviewMarkItem.index(e(this))+1)}function m(){I.reviewMarkItem.hover(d),I.reviewMarkItem.click(p),I.reviewForm.submit(s),I.closeReviewFormBtn.click(w)}function l(){I=e.extend(I,{jsAddReviewPopup:e(".js-addReviewPopup"),reviewMarkItem:e(".reviews-mark__item"),reviewForm:e("#review-form"),closeReviewFormBtn:e(".js-close-review-form"),reviewsWrap:e(".reviews-wrap")})}function v(){I.jsAddReviewPopup.show()}function f(){I.jsAddReviewPopup.remove(),i()}function w(e){e.preventDefault(),f()}function h(){o.scrollTo(0)}function j(e){var r="confirm"===e?{success:!0}:{};a(r),i(),l(),m(),v(),h()}var k={content:e(".js-content"),jsContentHidden:e(".js-content-hidden")},I={},x=e("#tpl-product-addReviewForm").html(),g={score:10,author:"",email:"",pros:"",cons:"",extract:""},C=t;!function(){j()}()}function n(r){r.preventDefault(),new t({productName:e(this).data("productName"),productId:e(this).data("productId")})}var o=e("body");o.on("click",".js-reviews-add",n)});