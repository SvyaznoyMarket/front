define(["jquery","mustache","module/config","module/util","jquery.popup","jquery.maskedinput"],function(t,o,e,n){var r=t("body"),s=t(".js-header"),u=s.css("position"),p="textfield-err",l=function(t){var o=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return o.test(t)},i=function(t){var o=t.closest(".js-slotButton-popup-element");("checkbox"==t.attr("type")?o:t).addClass(p),o.find(".js-slotButton-popup-element-error").show()},a=function(t){var o=t.closest(".js-slotButton-popup-element");("checkbox"==t.attr("type")?o:t).removeClass(p),o.find(".js-slotButton-popup-element-error").hide()},c=function(o,e){var n=t(".js-slotButton-popup-phone",o);return/\+7\(\d{3}\)\d{3}-\d{2}-\d{2}/.test(n.val().replace(/\s+/g,""))?(a(n),!0):(e||i(n),!1)},f=function(o,e){var n=t(".js-slotButton-popup-email",o);return 0==n.val().length||l(n.val())?(a(n),!0):(e||i(n),!1)},d=function(o,e){var n=t(".js-slotButton-popup-confirm",o);return n[0].checked?(a(n),!0):(e||i(n),!1)},m=function(o){var e,n=!0;return c(o)||(n=!1,e||(e=t(".js-slotButton-popup-phone",o).closest(".js-slotButton-popup-element"))),f(o)||(n=!1,e||(e=t(".js-slotButton-popup-email",o).closest(".js-slotButton-popup-element"))),d(o)||(n=!1,e||(e=t(".js-slotButton-popup-confirm",o).closest(".js-slotButton-popup-element"))),{isValid:n,$errorInput:e}},v=function(t){for(var o in t)if(t.hasOwnProperty(o))return t[o]},h=function(o){t("html, body").animate({scrollTop:/^\d+$/.test(o)?o:o.offset().top},"fast")};r.on("click",".js-slotButton",function(e){function r(){B.hide(0,function(){B.remove()}),j.css({opacity:1,height:"auto",overflow:"visible"}),s.css("position",u),h(0)}e.preventDefault();var p=t(this),l=p.data("value"),i=v(l.product),a=t(".js-content"),j=t(".js-content-hidden"),B=t(o.render(t("#tpl-cart-slot-form").html(),{full:l.isFull,partnerName:i.partnerName,partnerOfferUrl:i.partnerOfferUrl,productUrl:i.url,productId:i.id,userPhone:"",userEmail:"",userName:""})),k=t(".js-slotButton-popup-close",B),y=t("form",B),b=t(".js-slotButton-popup-errors",y),w=t(".js-slotButton-popup-phone",y),x=t(".js-slotButton-popup-email",y),g=(t(".js-slotButton-popup-name",y),t(".js-slotButton-popup-confirm",y));h(0),a.append(B),B.show(),j.css({overflow:"hidden",opacity:0,height:0}),s.css("position","absolute"),k.click(function(t){t.preventDefault(),r()}),t.mask.definitions.x="[0-9]",t.mask.placeholder="_",t.mask.autoclear=!1,t.map(t("input",B),function(o,e){var n=t(o);"undefined"!=typeof n.data("mask")&&n.mask(n.data("mask"))}),w.blur(function(){c(y)}),w.keyup(function(){c(y,!0)}),x.blur(function(){f(y)}),x.keyup(function(){f(y,!0)}),g.click(function(){d(y,!0)}),y.submit(function(e){e.preventDefault(),b.empty().hide();var s=m(y);if(!s.isValid)return void h(s.$errorInput);var u=t(".js-slotButton-popup-submitButton",y);u.attr("disabled","disabled"),t.ajax({type:"POST",url:y.attr("action"),data:y.serializeArray(),success:function(s){return s.error?(b.text(s.error).show(),void h(b)):(y.after(t(o.render(t("#tpl-cart-slot-form-result").html(),{orderNumber:s.order.number}))),y.remove(),t(".js-slotButton-popup-okButton",B).click(function(){e.preventDefault(),r()}),h(0),void n.sendOrdersToGoogleAnalytics([s.order]))},error:function(){b.text("Ошибка при создании заявки").show(),h(b)},complete:function(){u.removeAttr("disabled")}})}),w.focus()})});