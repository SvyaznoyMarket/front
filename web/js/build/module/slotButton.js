define(["jquery","mustache","module/config","module/util","jquery.popup","jquery.maskedinput"],function(t,o,e,n){var r=t("body"),s=t(".js-header"),u=(s.css("position"),"error"),p=function(t){var o=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return o.test(t)},l=function(o){var e=t(".js-slotButton-popup-element");("checkbox"==o.attr("type")?e:o).addClass(u),e.parent().find(".js-slotButton-popup-element-error").show()},i=function(o){var e=t(".js-slotButton-popup-element");("checkbox"==o.attr("type")?e:o).removeClass(u),e.parent().find(".js-slotButton-popup-element-error").hide()},a=function(o,e){var n=t(".js-slotButton-popup-phone",o);return/\+7\(\d{3}\)\d{3}-\d{2}-\d{2}/.test(n.val().replace(/\s+/g,""))?(i(n),!0):(e||l(n),!1)},c=function(o,e){var n=t(".js-slotButton-popup-email",o);return 0==n.val().length||p(n.val())?(i(n),!0):(e||l(n),!1)},f=function(o,e){var n=t(".js-slotButton-popup-confirm",o);return n[0].checked?(i(n),!0):(e||l(n),!1)},d=function(o){var e,n=!0;return a(o)||(n=!1,e||(e=t(".js-slotButton-popup-phone",o).closest(".js-slotButton-popup-element"))),c(o)||(n=!1,e||(e=t(".js-slotButton-popup-email",o).closest(".js-slotButton-popup-element"))),f(o)||(n=!1,e||(e=t(".js-slotButton-popup-confirm",o).closest(".js-slotButton-popup-element"))),{isValid:n,$errorInput:e}},m=function(t){for(var o in t)if(t.hasOwnProperty(o))return t[o]},v=function(o){t("html, body").animate({scrollTop:/^\d+$/.test(o)?o:o.offset().top},"fast")};r.on("click",".js-slotButton",function(e){function r(){j.hide(0,function(){j.remove()}),h.css({opacity:1,height:"auto",overflow:"visible"}),t(".top-banner").css("position","fixed"),s.css("position","fixed"),v(0)}e.preventDefault();var u=t(this),p=u.data("value"),l=m(p.product),i=t(".js-content"),h=t(".js-content-hidden"),j=t(o.render(t("#tpl-cart-slot-form").html(),{full:p.isFull,partnerName:l.partnerName,partnerOfferUrl:l.partnerOfferUrl,productUrl:l.url,productId:l.id,userPhone:"",userEmail:"",userName:""})),B=t(".js-slotButton-popup-close",j),b=t("form",j),k=t(".js-slotButton-popup-errors",b),y=t(".js-slotButton-popup-phone",b),x=t(".js-slotButton-popup-email",b),w=(t(".js-slotButton-popup-name",b),t(".js-slotButton-popup-confirm",b));v(0),i.append(j),j.show(),h.css({overflow:"hidden",opacity:0,height:0}),t(".top-banner").css("position","absolute"),s.css("position","absolute"),B.click(function(t){t.preventDefault(),r()}),t.mask.definitions.x="[0-9]",t.mask.placeholder="_",t.mask.autoclear=!1,t.map(t("input",j),function(o){var e=t(o);"undefined"!=typeof e.data("mask")&&e.mask(e.data("mask"))}),y.blur(function(){a(b)}),y.keyup(function(){a(b,!0)}),x.blur(function(){c(b)}),x.keyup(function(){c(b,!0)}),w.click(function(){f(b,!0)}),b.submit(function(e){e.preventDefault(),k.empty().hide();var s=d(b);if(!s.isValid)return void v(s.$errorInput);var u=t(".js-slotButton-popup-submitButton",b);u.attr("disabled","disabled"),t.ajax({type:"POST",url:b.attr("action"),data:b.serializeArray(),success:function(s){return s.error?(k.text(s.error).show(),void v(k)):(b.after(t(o.render(t("#tpl-cart-slot-form-result").html(),{orderNumber:s.order.number}))),b.remove(),t(".js-slotButton-popup-okButton",j).click(function(){e.preventDefault(),r()}),v(0),void n.sendOrdersToGoogleAnalytics([s.order]))},error:function(){k.text("Ошибка при создании заявки").show(),v(k)},complete:function(){u.removeAttr("disabled")}})}),y.focus()})});