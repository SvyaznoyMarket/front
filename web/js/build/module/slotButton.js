define(["jquery","mustache","module/config","module/util","jquery.popup","jquery.maskedinput"],function(t,o,e,r){var n=t("body"),s=t(".js-header"),u=(s.css("position"),"error"),p=function(t){var o=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return o.test(t)},l=function(o){var e=t(".js-slotButton-popup-element");("checkbox"==o.attr("type")?e:o).addClass(u),e.parent().find(".js-slotButton-popup-element-error").show()},a=function(o){var e=t(".js-slotButton-popup-element");("checkbox"==o.attr("type")?e:o).removeClass(u),e.parent().find(".js-slotButton-popup-element-error").hide()},i=function(o,e){var r=t(".js-slotButton-popup-phone",o);return/\+7\(\d{3}\)\d{3}-\d{2}-\d{2}/.test(r.val().replace(/\s+/g,""))?(a(r),!0):(e||l(r),!1)},c=function(o,e){var r=t(".js-slotButton-popup-email",o);return 0==r.val().length||p(r.val())?(a(r),!0):(e||l(r),!1)},d=function(o,e){var r=t(".js-slotButton-popup-confirm",o);return r[0].checked?(a(r),!0):(e||l(r),!1)},f=function(o){var e,r=!0;return i(o)||(r=!1,e||(e=t(".js-slotButton-popup-phone",o).closest(".js-slotButton-popup-element"))),c(o)||(r=!1,e||(e=t(".js-slotButton-popup-email",o).closest(".js-slotButton-popup-element"))),d(o)||(r=!1,e||(e=t(".js-slotButton-popup-confirm",o).closest(".js-slotButton-popup-element"))),{isValid:r,$errorInput:e}},m=function(t){for(var o in t)if(t.hasOwnProperty(o))return t[o]},v=function(o){t("html, body").animate({scrollTop:/^\d+$/.test(o)?o:o.offset().top},"fast")};n.on("click",".js-slotButton",function(e){function s(){j.hide(0,function(){j.remove()}),h.css({opacity:1,height:"auto",overflow:"visible"}),n.removeClass("body-modal"),v(0)}e.preventDefault();var u=t(this),p=u.data("value"),l=m(p.product),a=t(".js-content"),h=t(".js-content-hidden"),j=t(o.render(t("#tpl-cart-slot-form").html(),{full:p.isFull,partnerName:l.partnerName,partnerOfferUrl:l.partnerOfferUrl,productUrl:l.url,productId:l.id,userPhone:"",userEmail:"",userName:""})),B=t(".js-slotButton-popup-close",j),y=t("form",j),k=t(".js-slotButton-popup-errors",y),b=t(".js-slotButton-popup-phone",y),w=t(".js-slotButton-popup-email",y),g=(t(".js-slotButton-popup-name",y),t(".js-slotButton-popup-confirm",y));v(0),a.append(j),j.show(),h.css({overflow:"hidden",opacity:0,height:0}),n.addClass("body-modal"),B.click(function(t){t.preventDefault(),s()}),t.mask.definitions.x="[0-9]",t.mask.placeholder="_",t.mask.autoclear=!1,t.map(t("input",j),function(o){var e=t(o);"undefined"!=typeof e.data("mask")&&e.mask(e.data("mask"))}),b.blur(function(){i(y)}),b.keyup(function(){i(y,!0)}),w.blur(function(){c(y)}),w.keyup(function(){c(y,!0)}),g.click(function(){d(y,!0)}),y.submit(function(e){e.preventDefault(),k.empty().hide();var n=f(y);if(!n.isValid)return void v(n.$errorInput);var u=t(".js-slotButton-popup-submitButton",y);u.attr("disabled","disabled"),t.ajax({type:"POST",url:y.attr("action"),data:y.serializeArray(),success:function(n){return n.error?(k.text(n.error).show(),void v(k)):(y.after(t(o.render(t("#tpl-cart-slot-form-result").html(),{orderNumber:n.order.number}))),y.remove(),t(".js-slotButton-popup-okButton",j).click(function(){e.preventDefault(),s()}),v(0),r.sendOrdersToGoogleAnalytics([n.order]),void r.partner.flocktory.send({action:"postcheckout",orders:[n.order],spot:"mob_slot"}))},error:function(){k.text("Ошибка при создании заявки").show(),v(k)},complete:function(){u.removeAttr("disabled")}})}),b.focus()})});