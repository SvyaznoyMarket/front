define(["jquery","mustache","module/config","module/util","jquery.popup","jquery.maskedinput"],function(t,o,e,n){var r=t("body"),u=t(".js-header"),s=(u.css("position"),"error"),p=function(t){var o=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return o.test(t)},l=function(o){var e=t(".js-slotButton-popup-element");("checkbox"==o.attr("type")?e:o).addClass(s),e.parent().find(".js-slotButton-popup-element-error").show()},a=function(o){var e=t(".js-slotButton-popup-element");("checkbox"==o.attr("type")?e:o).removeClass(s),e.parent().find(".js-slotButton-popup-element-error").hide()},i=function(o,e){var n=t(".js-slotButton-popup-phone",o);return/\+7\(\d{3}\)\d{3}-\d{2}-\d{2}/.test(n.val().replace(/\s+/g,""))?(a(n),!0):(e||l(n),!1)},c=function(o,e){var n=t(".js-slotButton-popup-email",o);return 0==n.val().length||p(n.val())?(a(n),!0):(e||l(n),!1)},d=function(o,e){var n=t(".js-slotButton-popup-confirm",o);return n[0].checked?(a(n),!0):(e||l(n),!1)},f=function(o){var e,n=!0;return i(o)||(n=!1,e||(e=t(".js-slotButton-popup-phone",o).closest(".js-slotButton-popup-element"))),c(o)||(n=!1,e||(e=t(".js-slotButton-popup-email",o).closest(".js-slotButton-popup-element"))),d(o)||(n=!1,e||(e=t(".js-slotButton-popup-confirm",o).closest(".js-slotButton-popup-element"))),{isValid:n,$errorInput:e}},m=function(t){for(var o in t)if(t.hasOwnProperty(o))return t[o]},v=function(o){t("html, body").animate({scrollTop:/^\d+$/.test(o)?o:o.offset().top},"fast")};r.on("click",".js-slotButton",function(e){function u(){j.hide(0,function(){j.remove()}),h.css({opacity:1,height:"auto",overflow:"visible"}),r.removeClass("body-modal"),v(0)}e.preventDefault();var s=t(this),p=s.data("value"),l=m(p.product),a=t(".js-content"),h=t(".js-content-hidden"),j=t(o.render(t("#tpl-cart-slot-form").html(),{full:p.isFull,partnerName:l.partnerName,partnerOfferUrl:l.partnerOfferUrl,productUrl:l.url,productId:l.id,userPhone:"",userEmail:"",userName:""})),B=t(".js-slotButton-popup-close",j),y=t("form",j),k=t(".js-slotButton-popup-errors",y),b=t(".js-slotButton-popup-phone",y),w=t(".js-slotButton-popup-email",y),g=(t(".js-slotButton-popup-name",y),t(".js-slotButton-popup-confirm",y));v(0),a.append(j),j.show(),h.css({overflow:"hidden",opacity:0,height:0}),r.addClass("body-modal"),B.click(function(t){t.preventDefault(),u()}),t.mask.definitions.x="[0-9]",t.mask.placeholder="_",t.mask.autoclear=!1,t.map(t("input",j),function(o){var e=t(o);"undefined"!=typeof e.data("mask")&&e.mask(e.data("mask"))}),b.blur(function(){i(y)}),b.keyup(function(){i(y,!0)}),w.blur(function(){c(y)}),w.keyup(function(){c(y,!0)}),g.click(function(){d(y,!0)}),y.submit(function(e){e.preventDefault(),k.empty().hide();var r=f(y);if(!r.isValid)return void v(r.$errorInput);var s=t(".js-slotButton-popup-submitButton",y);s.attr("disabled","disabled"),t.ajax({type:"POST",url:y.attr("action"),data:y.serializeArray(),success:function(r){return r.error?(k.text(r.error).show(),void v(k)):(y.after(t(o.render(t("#tpl-cart-slot-form-result").html(),{orderNumber:r.order.number}))),y.remove(),t(".js-slotButton-popup-okButton",j).click(function(){e.preventDefault(),u()}),v(0),void n.sendOrdersToGoogleAnalytics([r.order]))},error:function(){k.text("Ошибка при создании заявки").show(),v(k)},complete:function(){s.removeAttr("disabled")}})}),b.focus()})});